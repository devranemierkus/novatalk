<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>NovaTalk - Akƒ±llƒ± Sesli & G√∂r√ºnt√ºl√º Asistan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      color: #2c3e50;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0;
      overflow-x: hidden;
    }
    h1 {
      color: #2980b9;
      margin-bottom: 25px;
      font-size: 2.8em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      letter-spacing: 1px;
    }
    div {
      margin-bottom: 15px;
    }
    button {
      font-size: 1.15em;
      padding: 15px 35px;
      margin: 12px;
      border-radius: 30px;
      border: none;
      background-color: #27ae60;
      color: white;
      cursor: pointer;
      min-width: 200px;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      user-select: none;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      letter-spacing: 0.8px;
      font-weight: 600;
    }
    button:hover {
      background-color: #2ecc71;
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    button.stop {
      background-color: #e74c3c;
    }
    button.stop:hover {
      background-color: #c0392b;
    }
    button#btnRequestPermissions {
      background-color: #3498db;
    }
    button#btnRequestPermissions:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
      opacity: 0.7;
    }
    video {
      margin-top: 30px;
      max-width: 450px;
      width: 90%;
      border-radius: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
      display: none;
      background-color: #000;
      border: 5px solid #3498db;
    }
    #status {
      margin-top: 30px;
      font-size: 1.2em;
      color: #2c3e50;
      font-weight: bold;
      min-height: 30px;
      text-shadow: 0 1px 1px rgba(255,255,255,0.5);
    }
    #log {
      margin-top: 25px;
      max-width: 450px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      background: #ecf0f1;
      padding: 20px;
      border-radius: 15px;
      font-size: 1em;
      white-space: pre-wrap;
      min-height: 120px;
      color: #34495e;
      border: 1px solid #bdc3c7;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      overflow-y: auto;
      max-height: 250px;
      text-align: left;
      line-height: 1.5;
    }
  </style>
</head>
<body>

  <h1>NovaTalk üöÄ</h1>

  <div>
    <button id="btnRequestPermissions">üîê ƒ∞zinleri Al</button>
  </div>
  <div>
    <button id="btnAudioStart" disabled>üé§ Sesli Asistanƒ± Ba≈ülat</button>
    <button id="btnAudioStop" class="stop" disabled>‚èπÔ∏è Sesli Asistanƒ± Durdur</button>
  </div>
  <div>
    <button id="btnVideoStart" disabled>üìπ G√∂r√ºnt√ºl√º Konu≈üma Ba≈ülat</button>
    <button id="btnVideoStop" class="stop" disabled>‚èπÔ∏è G√∂r√ºnt√ºl√º Konu≈ümayƒ± Durdur</button>
  </div>

  <video id="video" autoplay playsinline></video>

  <div id="status"></div>
  <div id="log">Konu≈üma logu buraya gelecek...</div>

  <script>
    const btnRequestPermissions = document.getElementById('btnRequestPermissions');
    const btnAudioStart = document.getElementById('btnAudioStart');
    const btnAudioStop = document.getElementById('btnAudioStop');
    const btnVideoStart = document.getElementById('btnVideoStart');
    const btnVideoStop = document.getElementById('btnVideoStop');
    const video = document.getElementById('video');
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');

    let recognition = null;
    let audioStream = null;
    let videoStream = null;
    let isListening = false; // SpeechRecognition'ƒ±n dinleme durumunu kontrol eder
    const RESTART_DELAY = 2000; // 2 saniye gecikme

    let selectedVoice = null; // Tercih edilen ses motorunu tutacak deƒüi≈üken

    // Ses motorlarƒ± hazƒ±r olduƒüunda √ßaƒürƒ±lƒ±r
    window.speechSynthesis.onvoiceschanged = () => {
        const voices = window.speechSynthesis.getVoices();
        const turkishVoices = voices.filter(voice => voice.lang.startsWith('tr'));

        // Konsola bulunan sesleri yazdƒ±r (debugging i√ßin √∂nemli)
        appendToLog(`Bulunan T√ºrk√ße sesler: ${turkishVoices.map(v => v.name + ' (' + v.lang + ')').join(', ')}`);

        // Daha doƒüal bir ses bulmaya √ßalƒ±≈ü (√∂ncelik sƒ±rasƒ± √∂nemli)
        // Genellikle Google veya Microsoft sesleri daha iyidir.
        selectedVoice = turkishVoices.find(voice => voice.name.includes('Google') && voice.name.includes('Turkish')) ||
                        turkishVoices.find(voice => voice.name.includes('Microsoft') && voice.name.includes('Turkish')) ||
                        turkishVoices.find(voice => voice.name.includes('Microsoft') && voice.name.includes('David')) || // Windows varsayƒ±lan ƒ∞ngilizce erkek sesi (test i√ßin)
                        turkishVoices.find(voice => voice.name.includes('Microsoft') && voice.name.includes('Zira')) || // Windows varsayƒ±lan ƒ∞ngilizce kadƒ±n sesi (test i√ßin)
                        turkishVoices[0]; // Hi√ßbiri bulunamazsa ilk T√ºrk√ße sesi kullan

        if (selectedVoice) {
            appendToLog(`NovaTalk i√ßin se√ßilen ses: "${selectedVoice.name}"`);
            // Se√ßilen sesi test etmek i√ßin ilk izin alƒ±ndƒ±ƒüƒ±nda konu≈üma testi yapƒ±labilir
        } else {
            appendToLog('Uyarƒ±: Hi√ß T√ºrk√ße ses bulunamadƒ±. L√ºtfen sisteminizin T√ºrk√ße ses paketlerini kontrol edin.');
            updateStatus('Uyarƒ±: Sesli yanƒ±t verilemeyebilir. L√ºtfen sisteminizin T√ºrk√ße ses paketlerini kontrol edin.');
        }
    };


    // Loglama fonksiyonu: Mesajlarƒ± hem HTML'e hem de konsola yazdƒ±rƒ±r
    function appendToLog(message) {
      if (logDiv) {
        const now = new Date();
        const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        logDiv.textContent += `\n[${time}] ${message}`;
        logDiv.scrollTop = logDiv.scrollHeight; // Kaydƒ±rma √ßubuƒüunu a≈üaƒüƒ± indir
      }
      console.log(`[LOG]: ${message}`); // Her zaman konsola da yaz
    }

    // Durum mesajlarƒ±nƒ± g√ºncelleyen fonksiyon
    function updateStatus(message) {
        if (statusDiv) {
            statusDiv.textContent = message;
        }
        appendToLog(`DURUM: ${message}`);
    }

    // Botun sesli yanƒ±t vermesini saƒülayan fonksiyon
    function botSpeak(text) {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel(); // √ñnceki konu≈ümayƒ± iptal et
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'tr-TR'; // Dil ayarƒ± hala √∂nemli

      // Eƒüer bir ses se√ßildiyse, onu kullan
      if (selectedVoice) {
          utterance.voice = selectedVoice;
      } else {
          appendToLog("Uyarƒ±: 'selectedVoice' ayarlanmadƒ±, varsayƒ±lan T√ºrk√ße ses kullanƒ±lacak.");
      }

      utterance.pitch = 1;
      utterance.rate = 1;
      utterance.volume = 1;

      utterance.onend = () => {
        appendToLog("Bot konu≈ümasƒ± bitti.");
        // Bot konu≈ümasƒ± bittikten sonra 2 saniye bekleyip tekrar dinlemeyi ba≈ülat
        if (isListening) { // isListening true ise, yani asistan hala aktifse
            updateStatus(`NovaTalk konu≈ümasƒ±nƒ± bitirdi. ${RESTART_DELAY / 1000} saniye i√ßinde tekrar dinlemeye ba≈ülayacaƒüƒ±m...`);
            appendToLog(`Bekleniyor: ${RESTART_DELAY / 1000} saniye sonra tekrar dinleme ba≈ülayacak.`);
            setTimeout(() => {
                if (isListening && recognition && recognition.start) { // Tekrar kontrol et
                    try {
                        recognition.start();
                        updateStatus('Dinlemeye devam ediyorum... Mikrofon a√ßƒ±k.');
                    } catch (e) {
                        appendToLog(`Bot konu≈ümasƒ± sonrasƒ± dinleme ba≈ülatƒ±lƒ±rken hata: ${e.message}`);
                        console.error("Recognition re-start after botSpeak error:", e);
                        updateStatus('Dinleme hatasƒ± olu≈ütu. L√ºtfen tekrar ba≈ülatƒ±n.');
                        isListening = false;
                        stopRecognition();
                        setButtonStates(false, false, false, false, true); // ƒ∞zin butonunu tekrar aktif et
                    }
                }
            }, RESTART_DELAY);
        }
      };

      utterance.onerror = (event) => {
        appendToLog(`Bot konu≈üma hatasƒ±: ${event.error}. Metin: "${text}"`);
        console.error("SpeechSynthesis error:", event.error, "Utterance:", utterance);
        updateStatus('Bot konu≈üurken hata olu≈ütu. L√ºtfen konsolu kontrol edin.');
        // Hata durumunda da dinlemeye devam etmeye √ßalƒ±≈ü, kullanƒ±cƒ± d√∂ng√ºde kalmasƒ±n
        if (isListening && recognition && recognition.start && event.error !== 'network') { // Aƒü hatasƒ± deƒüilse tekrar dene
            updateStatus('Bot konu≈üma hatasƒ±. Dinlemeye devam ediyorum...');
            setTimeout(() => {
                try {
                    recognition.start();
                } catch (e) {
                    appendToLog(`Bot konu≈üma hatasƒ± sonrasƒ± dinleme ba≈ülatƒ±lƒ±rken hata: ${e.message}`);
                    console.error("Recognition re-start after botSpeak error:", e);
                }
            }, RESTART_DELAY / 2); // Daha hƒ±zlƒ± tekrar ba≈ülatma denemesi
        }
      };
      
      // Sesin ger√ßekten oynatƒ±ldƒ±ƒüƒ±ndan emin olmak i√ßin bir kontrol
      try {
        speechSynthesis.speak(utterance);
        appendToLog(`NovaTalk s√∂yledi: "${text}"`); // Botun s√∂ylediƒüi metni loga yaz
      } catch (e) {
        appendToLog(`SpeechSynthesis.speak() √ßaƒürƒ±lƒ±rken hata: ${e.message}`);
        console.error("SpeechSynthesis speak call error:", e);
        updateStatus('Bot konu≈üma ba≈ülatƒ±lamadƒ±. Tarayƒ±cƒ± ses motoru hatasƒ±.');
      }
    }

    // Ses tanƒ±mayƒ± ba≈ülatan fonksiyon
    function startRecognition() {
      // Tarayƒ±cƒ± uyumluluk kontrol√º (bu kontrol√º izin almadan √∂nce de yapabiliriz)
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        updateStatus('Tarayƒ±cƒ±nƒ±z ses tanƒ±mayƒ± desteklemiyor! L√ºtfen Chrome gibi destekleyen bir tarayƒ±cƒ± kullanƒ±n.');
        appendToLog('Hata: Tarayƒ±cƒ± ses tanƒ±mayƒ± desteklemiyor.');
        alert('Tarayƒ±cƒ±nƒ±z ses tanƒ±mayƒ± desteklemiyor! L√ºtfen Chrome gibi destekleyen bir tarayƒ±cƒ± kullanƒ±n.');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'tr-TR';
      recognition.interimResults = false; // Ara sonu√ßlarƒ± deƒüil, sadece kesin sonu√ßlarƒ± d√∂nd√ºr
      recognition.maxAlternatives = 1; // En iyi tahmini d√∂nd√ºr
      recognition.continuous = false; // Konu≈üma durduktan sonra otomatik olarak durdur

      recognition.onstart = () => {
        updateStatus('Konu≈ümanƒ± dinliyorum... Mikrofonun a√ßƒ±k.');
        appendToLog('Ses tanƒ±ma ba≈ülatƒ±ldƒ±. Dinleniyor...');
        // isListening = true; // Bu artƒ±k ba≈ülatma butonuna basƒ±ldƒ±ƒüƒ±nda ayarlanƒ±yor
      };

      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript.toLowerCase();
        appendToLog('Sen s√∂yledin: "' + text + '"'); // Kullanƒ±cƒ±nƒ±n s√∂ylediƒüi metni loga yaz
        updateStatus('Anladƒ±m: ' + text);
        
        // Kullanƒ±cƒ± konu≈ümayƒ± bitirdiƒüinde ses tanƒ±mayƒ± durdururuz
        // Bot yanƒ±tƒ± tamamlandƒ±ktan sonra yeniden ba≈ülatƒ±lacak
        if (recognition) {
            recognition.stop(); 
            appendToLog('Kullanƒ±cƒ± konu≈ümasƒ± bitti, ses tanƒ±ma ge√ßici olarak durduruldu.');
        }

        botReply(text); // Botun yanƒ±t vermesi
      };

      recognition.onerror = (event) => {
        updateStatus('Hata: ' + event.error);
        appendToLog(`Ses tanƒ±ma hatasƒ±: ${event.error}. Detay: ${event.message || 'Bilinmiyor.'}`);
        console.error("SpeechRecognition error:", event.error);

        if (event.error === 'not-allowed') {
          appendToLog('Mikrofon eri≈üimi reddedildi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan izin verin.');
          updateStatus('Mikrofon izni reddedildi. Tekrar denemek i√ßin sayfayƒ± yenileyip izinleri yeniden alƒ±n.');
        } else if (event.error === 'no-speech') {
          appendToLog('Konu≈üma algƒ±lanmadƒ±. L√ºtfen daha net ve yakƒ±n konu≈üun.');
          updateStatus('Konu≈üma algƒ±lanmadƒ±. Tekrar deniyorum...');
          if(isListening && !speechSynthesis.speaking) { // Eƒüer hala dinlemede kalmasƒ± gerekiyorsa ve bot konu≈ümuyorsa
              setTimeout(() => {
                  try {
                      recognition.start();
                  } catch (e) {
                      appendToLog(`'no-speech' sonrasƒ± tekrar ba≈ülatƒ±lƒ±rken hata: ${e.message}`);
                      console.error("Recognition restart after no-speech error:", e);
                  }
              }, 500);
          }
        } else if (event.error === 'audio-capture') {
          appendToLog('Mikrofon ≈üu anda kullanƒ±lamƒ±yor veya ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lƒ±yor.');
          updateStatus('Mikrofon hatasƒ±. Ba≈üka bir uygulama kullanƒ±yor olabilir.');
        } else if (event.error === 'network') {
          appendToLog('Aƒü baƒülantƒ± hatasƒ±. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.');
          updateStatus('Aƒü hatasƒ±. Baƒülantƒ±nƒ±zƒ± kontrol edin.');
        } else if (event.error === 'aborted') {
            appendToLog('Ses tanƒ±ma i≈ülemi iptal edildi.');
        }
        
        // Ciddi bir hata durumunda asistanƒ± tamamen durdur
        if (isListening && !['no-speech', 'aborted'].includes(event.error)) {
             isListening = false;
             stopRecognition(); // Kalƒ±cƒ± olarak durdur
             updateStatus('Bir hata nedeniyle asistan durduruldu.');
             setButtonStates(false, false, false, false, true); // ƒ∞zin butonunu tekrar aktif et
        }
      };

      recognition.onend = () => {
        appendToLog('Ses tanƒ±ma sona erdi (onend tetiklendi).');
        // Dinleme durumu true ise ve bot konu≈ümuyorsa, bu kullanƒ±cƒ±nƒ±n konu≈ümasƒ±nƒ±n bittiƒüi anlamƒ±na gelir.
        // Yeniden ba≈ülatma botSpeak i√ßindeki gecikmeli setTimeout ile y√∂netilir.
        if (!isListening) { // Eƒüer isListening false ise, asistan tamamen durdurulmu≈ü demektir
             updateStatus('Ses tanƒ±ma durdu.');
             appendToLog('Ses tanƒ±ma kalƒ±cƒ± olarak durduruldu (isListening false).');
        } else if (!speechSynthesis.speaking) {
            // isListening true ama bot konu≈ümuyor (kullanƒ±cƒ± konu≈ümasƒ± bitti), o zaman botun yanƒ±tƒ±nƒ± bekliyoruz.
            // Bu durumda recognition.start() botSpeak'in sonunda yapƒ±lacak.
            updateStatus('Konu≈üma bitti. Botun yanƒ±tƒ± bekleniyor...');
        }
      };

      try {
        recognition.start();
      } catch (e) {
        appendToLog(`Ses tanƒ±ma ba≈ülatƒ±lƒ±rken genel hata olu≈ütu: ${e.message}`);
        console.error("Recognition start initial error:", e);
        updateStatus('Ses tanƒ±ma ba≈ülatƒ±lamadƒ±. L√ºtfen izinleri tekrar kontrol edin.');
        isListening = false;
        setButtonStates(false, false, false, false, true); // ƒ∞zin butonunu tekrar aktif et
      }
    }

    // Botun kullanƒ±cƒ±nƒ±n s√∂ylediklerine verdiƒüi yanƒ±tlar (Konu≈üma Mantƒ±ƒüƒ±)
    function botReply(text) {
      let replyText = '';
      const now = new Date();

      if (text.includes('merhaba') || text.includes('selam')) {
        replyText = 'Merhaba! NovaTalk hizmetinizdeyim. Size nasƒ±l yardƒ±mcƒ± olabilirim?';
      } else if (text.includes('nasƒ±lsƒ±n')) {
        replyText = 'Ben bir yapay zekayƒ±m, iyiyim te≈üekk√ºr ederim. Siz nasƒ±lsƒ±nƒ±z?';
      } else if (text.includes('adƒ±n ne') || text.includes('kimsin')) {
        replyText = 'Ben NovaTalk, dijital asistanƒ±nƒ±zƒ±m.';
      } else if (text.includes('saat ka√ß') || text.includes('saati s√∂yle')) {
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        replyText = `≈ûu an saat ${hours}:${minutes}.`;
      } else if (text.includes('bug√ºn g√ºnlerden ne') || text.includes('tarih ne')) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        replyText = `Bug√ºn ${now.toLocaleDateString('tr-TR', options)}.`;
      } else if (text.includes('yardƒ±m et') || text.includes('ne yapabilirsin')) {
        replyText = 'Size saati s√∂yleyebilir, g√ºn√ºn tarihini belirtebilir veya sadece sohbet edebilirim. Ne sormak istersiniz?';
      } else if (text.includes('g√ºle g√ºle') || text.includes('g√∂r√º≈ü√ºr√ºz') || text.includes('kapat') || text.includes('bitir')) {
        replyText = 'G√∂r√º≈ümek √ºzere! Kendinize iyi bakƒ±n.';
        isListening = false; // Kapatma komutunda dinlemeyi durdur
        setTimeout(() => stopAll(), 1500); // Bot konu≈ümayƒ± bitirdikten sonra kapat
      } else {
        const randomReplies = [
          '√úzg√ºn√ºm, dediƒüinizi tam anlayamadƒ±m. Tekrar s√∂yler misiniz?',
          'L√ºtfen daha net konu≈üur musunuz?',
          'Kusura bakmayƒ±n, anlayamadƒ±m. Ne demek istediniz?',
          'Tekrar edebilir misiniz?'
        ];
        replyText = randomReplies[Math.floor(Math.random() * randomReplies.length)];
      }
      botSpeak(replyText);
    }

    // Ses tanƒ±mayƒ± durduran fonksiyon
    function stopRecognition() {
      if(recognition) {
        // isListening = false; // Bu bayrak stopAll i√ßinde veya hata durumunda ayarlanmalƒ±
        recognition.stop();
        appendToLog('Ses tanƒ±ma durdurma komutu g√∂nderildi.');
      }
      recognition = null;
    }

    // Kamera ve mikrofon akƒ±≈ülarƒ±nƒ± durduran fonksiyon
    function stopStreams() {
      if(audioStream) {
        audioStream.getTracks().forEach(t => t.stop());
        audioStream = null;
        appendToLog('Ses akƒ±≈üƒ± durduruldu.');
      }
      if(videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
        video.srcObject = null;
        appendToLog('Video akƒ±≈üƒ± durduruldu.');
      }
      video.style.display = 'none';
    }

    // T√ºm aktif i≈ülemleri durduran ana fonksiyon
    function stopAll() {
      appendToLog('T√ºm konu≈üma ve akƒ±≈ülar sonlandƒ±rƒ±lƒ±yor...');
      speechSynthesis.cancel(); // Konu≈ümayƒ± da durdur
      isListening = false; // Dinlemeyi tamamen kapat
      stopRecognition();
      stopStreams();
      updateStatus('Konu≈üma sonlandƒ±rƒ±ldƒ±. Tekrar ba≈ülatmak i√ßin izinleri alƒ±p d√ºƒümelere tƒ±klayƒ±n.');
      appendToLog('NovaTalk tamamen sonlandƒ±rƒ±ldƒ±.');
      setButtonStates(false, false, false, false, true); // ƒ∞zin butonunu tekrar aktif et
    }

    // Butonlarƒ±n durumunu ayarlayan yardƒ±mcƒ± fonksiyon
    function setButtonStates(audioStart, audioStop, videoStart, videoStop, requestPermissions) {
        btnAudioStart.disabled = !audioStart;
        btnAudioStop.disabled = !audioStop;
        btnVideoStart.disabled = !videoStart;
        btnVideoStop.disabled = !videoStop;
        btnRequestPermissions.disabled = !requestPermissions;
    }

    // Sayfa y√ºklendiƒüinde ba≈ülangƒ±√ß log mesajƒ±nƒ± ve durumu g√∂ster
    appendToLog("NovaTalk hazƒ±r. L√ºtfen 'ƒ∞zinleri Al' d√ºƒümesine tƒ±klayarak ba≈ülayƒ±n.");
    updateStatus("Ho≈ü geldiniz! ƒ∞zinleri alarak ba≈ülayƒ±n.");
    setButtonStates(false, false, false, false, true); // ƒ∞lk ba≈üta sadece izin butonu aktif


    // ƒ∞zinleri Al d√ºƒümesine tƒ±klama olayƒ±
    btnRequestPermissions.onclick = () => {
        appendToLog('ƒ∞zinler isteniyor...');
        updateStatus('Mikrofon ve kamera izinleri bekleniyor...');
        // Audio iznini istememiz yeterli, √ß√ºnk√º ses sentezi mikrofon izninden baƒüƒ±msƒ±zdƒ±r
        // Ama video da olduƒüu i√ßin ikisini birden isteyelim, sorun olmasƒ±n.
        navigator.mediaDevices.getUserMedia({ audio: true, video: true })
            .then(stream => {
                stream.getTracks().forEach(t => t.stop()); // Akƒ±≈ülarƒ± hemen durdur
                appendToLog('Kamera ve mikrofon izinleri ba≈üarƒ±yla alƒ±ndƒ±.');
                updateStatus('ƒ∞zinler alƒ±ndƒ±. Sesli veya G√∂r√ºnt√ºl√º Asistanƒ± ba≈ülatabilirsiniz.');
                setButtonStates(true, false, true, false, false); // Ba≈ülatma butonlarƒ±nƒ± aktif et, izin butonunu pasif et

                // ƒ∞zinler alƒ±ndƒ±ktan sonra ses motorunun da hazƒ±r olduƒüundan emin olalƒ±m
                if (speechSynthesis.getVoices().length === 0) {
                     // Eƒüer sesler hen√ºz y√ºklenmediyse, onvoiceschanged event'ini bekle
                     appendToLog("Ses motorlarƒ± hen√ºz y√ºklenmemi≈ü, y√ºklendiklerinde se√ßilecek.");
                } else {
                    // Sesler zaten y√ºkl√º ise, se√ßimi yapƒ±ldƒ±ysa bir test konu≈ümasƒ± yapabiliriz.
                    botSpeak("Merhaba, izinler alƒ±ndƒ±. NovaTalk kullanƒ±ma hazƒ±r.");
                }
            })
            .catch(err => {
                appendToLog('ƒ∞zin alma hatasƒ±: ' + err.name + " - " + err.message);
                console.error("Permission request error:", err);
                updateStatus('ƒ∞zinler reddedildi veya bir hata olu≈ütu. L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zƒ± kontrol edin.');
                setButtonStates(false, false, false, false, true);
                alert('Mikrofon veya kamera izni reddedildi. Uygulamanƒ±n √ßalƒ±≈ümasƒ± i√ßin izin vermeniz gerekiyor.');
            });
    };


    // Sesli Konu≈üma Ba≈ülat d√ºƒümesine tƒ±klama olayƒ±
    btnAudioStart.onclick = () => {
      stopAll(); // √ñnceki t√ºm i≈ülemleri durdur
      appendToLog('Sesli asistan ba≈ülatma isteƒüi.');
      updateStatus('Mikrofon ba≈ülatƒ±lƒ±yor...');

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          audioStream = stream;
          video.style.display = 'none';
          updateStatus('Sesli asistan ba≈ülatƒ±ldƒ±. Dinliyorum...');
          appendToLog('Mikrofon akƒ±≈üƒ± alƒ±ndƒ±. Ses tanƒ±ma ba≈ülatƒ±lƒ±yor.');

          setButtonStates(false, true, false, false, false); // Sesli ba≈ülat pasif, durdur aktif, diƒüerleri pasif

          isListening = true; // Dinleme durumunu aktif et
          startRecognition(); // Ses tanƒ±mayƒ± ba≈ülat
        })
        .catch(err => {
          updateStatus('Mikrofon ba≈ülatma hatasƒ±: ' + err.message);
          appendToLog('Hata: Mikrofon akƒ±≈üƒ± ba≈ülatƒ±lamadƒ±. Detay: ' + err.name + " - " + err.message);
          console.error("getUserMedia (audio) error:", err);
          stopAll();
          alert('Mikrofon ba≈ülatƒ±lamadƒ±. Ba≈üka bir uygulama kullanƒ±yor olabilir.');
        });
    };

    // Sesli Konu≈ümayƒ± Durdur d√ºƒümesine tƒ±klama olayƒ±
    btnAudioStop.onclick = () => {
      stopAll();
      appendToLog('Sesli asistan durduruldu.');
    };

    // G√∂r√ºnt√ºl√º Konu≈üma Ba≈ülat d√ºƒümesine tƒ±klama olayƒ±
    btnVideoStart.onclick = () => {
      stopAll();
      appendToLog('G√∂r√ºnt√ºl√º konu≈üma ba≈ülatma isteƒüi.');
      updateStatus('Kamera ve mikrofon ba≈ülatƒ±lƒ±yor...');

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.style.display = 'block';
          updateStatus('G√∂r√ºnt√ºl√º konu≈üma ba≈ülatƒ±ldƒ±. Dinliyorum...');
          appendToLog('Kamera ve mikrofon akƒ±≈üƒ± alƒ±ndƒ±. Ses tanƒ±ma ba≈ülatƒ±lƒ±yor.');

          setButtonStates(false, false, false, true, false);
          
          isListening = true;
          startRecognition();
        })
        .catch(err => {
          updateStatus('Kamera veya mikrofon ba≈ülatma hatasƒ±: ' + err.message);
          appendToLog('Hata: Kamera veya mikrofon akƒ±≈üƒ± ba≈ülatƒ±lamadƒ±. Detay: ' + err.name + " - " + err.message);
          console.error("getUserMedia (video+audio) error:", err);
          stopAll();
          alert('Kamera veya mikrofon ba≈ülatƒ±lamadƒ±. Ba≈üka bir uygulama kullanƒ±yor olabilir.');
        });
    };

    // G√∂r√ºnt√ºl√º Konu≈ümayƒ± Durdur d√ºƒümesine tƒ±klama olayƒ±
    btnVideoStop.onclick = () => {
      stopAll();
      appendToLog('G√∂r√ºnt√ºl√º konu≈üma durduruldu.');
    };
  </script>

</body>
</html>
