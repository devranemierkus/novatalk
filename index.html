<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaTalk - G√∂r√ºnt√ºl√º & Sesli Sohbet</title>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif; background: #ece5dd;
    }
    header {
      background: #075e54; color: white; padding: 16px; text-align: center; font-size: 24px;
    }
    #callScreen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 80vh;
      background: #128c7e;
      color: white;
      text-align: center;
      position: relative;
    }
    #spinner {
      border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid white;
      border-radius: 50%;
      width: 60px; height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% {transform: rotate(0deg);}
      100% {transform: rotate(360deg);}
    }
    #video {
      width: 90%;
      max-width: 400px;
      margin-top: 20px;
      border-radius: 12px;
      background: black;
    }
    #log {
      background: white; margin: 10px; padding: 10px;
      border-radius: 8px; min-height: 120px;
      max-height: 180px; overflow-y: auto;
      white-space: pre-wrap; font-size: 14px; font-family: monospace;
    }
    footer {
      display: flex; justify-content: space-around;
      padding: 15px; background: #f0f0f0;
    }
    button {
      padding: 12px 20px; font-size: 16px;
      border: none; border-radius: 30px; cursor: pointer;
      user-select: none;
    }
    #startAudioBtn { background: #25d366; color: white; }
    #startVideoBtn { background: #34b7f1; color: white; }
    #endCallBtn {
      background: #dc3545; color: white;
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.7);
      transition: background-color 0.3s;
    }
    #endCallBtn:hover {
      background-color: #b02a37;
    }
    #permissionOverlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      z-index: 1000;
      padding: 20px;
      text-align: center;
    }
    #permissionOverlay button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 30px;
      border: none;
      background: #25d366;
      cursor: pointer;
      color: white;
      user-select: none;
    }
    #statusMsg {
      margin-top: 10px;
      font-weight: bold;
      font-size: 18px;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <header>NovaTalk</header>

  <div id="permissionOverlay">
    <div>NovaTalk mikrofon ve kamera eri≈üimi istiyor.</div>
    <div>L√ºtfen izin verin.</div>
    <button id="grantPermissionBtn">ƒ∞zin Ver</button>
  </div>

  <div id="callScreen">
    <div id="spinner"></div>
    <div id="status">ChatNova aranƒ±yor...</div>
    <video id="video" autoplay playsinline muted></video>
    <div id="statusMsg"></div>
  </div>

  <div id="log">üìù Konu≈ümalar buraya yazƒ±lacak...</div>

  <footer>
    <button id="startAudioBtn">üé§ Sesli Arama</button>
    <button id="startVideoBtn">üìπ G√∂r√ºnt√ºl√º Arama</button>
    <button id="endCallBtn">üî¥ Aramayƒ± Bitir</button>
  </footer>

  <script>
    const permissionOverlay = document.getElementById('permissionOverlay');
    const grantPermissionBtn = document.getElementById('grantPermissionBtn');
    const callScreen = document.getElementById('callScreen');
    const spinner = document.getElementById('spinner');
    const status = document.getElementById('status');
    const statusMsg = document.getElementById('statusMsg');
    const video = document.getElementById('video');
    const log = document.getElementById('log');
    const startAudioBtn = document.getElementById('startAudioBtn');
    const startVideoBtn = document.getElementById('startVideoBtn');
    const endCallBtn = document.getElementById('endCallBtn');

    let recognition = null;
    let inactivityTimer = null;
    let callActive = false;
    let audioStream = null;
    let videoStream = null;
    let botHasGreeted = false;

    // ƒ∞zin isteme ve ba≈ülatma
    function requestPermissions(withVideo = false) {
      return navigator.mediaDevices.getUserMedia({ audio: true, video: withVideo });
    }

    // Konu≈üma durumu kontrol√º
    function resetInactivityTimer() {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        speak('Dostum, konu≈ümuyorsun. Kapatmak zorundayƒ±m.');
        endCall();
      }, 15000); // 15 saniye sessizlik sonrasƒ± kapanƒ±r
    }

    // Botun konu≈ümasƒ± (ses sentezi)
    function speak(text) {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'tr-TR';
      utterance.pitch = 1.05;
      utterance.rate = 1;
      speechSynthesis.speak(utterance);
    }

    // Loga yaz
    function logMessage(text) {
      log.textContent += '\n' + text;
      log.scrollTop = log.scrollHeight;
    }

    // Konu≈üma tanƒ±ma ba≈ülat
    function startRecognition() {
      if (recognition) recognition.stop();

      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'tr-TR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        statusMsg.textContent = 'üé§ Dinleniyor...';
        if (!botHasGreeted) {
          speak('Selam! Seni dinliyorum.');
          botHasGreeted = true;
        }
      };

      recognition.onresult = (event) => {
        const userText = event.results[0][0].transcript;
        logMessage('üë§ Sen: ' + userText);
        botReply(userText);
        resetInactivityTimer();
      };

      recognition.onerror = (event) => {
        logMessage('‚ö†Ô∏è Hata: ' + event.error);
      };

      recognition.onend = () => {
        if (callActive) {
          recognition.start();
        }
      };

      recognition.start();
      resetInactivityTimer();
    }

    // Basit bot yanƒ±tlarƒ± (geli≈ütirilebilir, API ile deƒüi≈ütirilebilir)
    function botReply(userText) {
      userText = userText.toLowerCase();
      let reply = '';

      if (userText.includes('nasƒ±lsƒ±n')) {
        reply = 'ƒ∞yiyim, te≈üekk√ºr ederim! Sen nasƒ±lsƒ±n?';
      } else if (userText.includes('merhaba')) {
        reply = 'Merhaba! Sana nasƒ±l yardƒ±mcƒ± olabilirim?';
      } else if (userText.includes('g√∂r√º≈ü√ºr√ºz') || userText.includes('ho≈ü√ßa kal')) {
        reply = 'G√∂r√º≈ümek √ºzere! ƒ∞yi g√ºnler!';
        speak(reply);
        endCall();
        return;
      } else {
        reply = '√úzg√ºn√ºm, bunu anlayamadƒ±m. L√ºtfen tekrar eder misin?';
      }

      speak(reply);
      logMessage('ü§ñ ChatNova: ' + reply);
    }

    // Aramayƒ± sonlandƒ±r
    function endCall() {
      callActive = false;
      if (recognition) recognition.stop();
      if (audioStream) audioStream.getTracks().forEach(t => t.stop());
      if (videoStream) videoStream.getTracks().forEach(t => t.stop());
      video.srcObject = null;
      video.style.display = 'none';
      status.textContent = 'G√∂r√º≈üme sonlandƒ±rƒ±ldƒ±.';
      statusMsg.textContent = '';
      spinner.style.display = 'none';
      startAudioBtn.style.display = 'inline-block';
      startVideoBtn.style.display = 'inline-block';
      endCallBtn.style.display = 'none';
      botHasGreeted = false;
      logMessage('üî¥ Arama sonlandƒ±.');
      clearTimeout(inactivityTimer);
    }

    // Aramayƒ± ba≈ülat
    function startCall(withVideo = false) {
      permissionOverlay.style.display = 'none';
      callActive = true;
      spinner.style.display = 'block';
      status.textContent = 'ChatNova aranƒ±yor...';
      statusMsg.textContent = '';
      startAudioBtn.style.display = 'none';
      startVideoBtn.style.display = 'none';
      endCallBtn.style.display = 'inline-block';

      requestPermissions(withVideo).then(stream => {
        if (withVideo) {
          videoStream = stream;
          video.srcObject = stream;
          video.style.display = 'block';
          audioStream = new MediaStream(stream.getAudioTracks());
        } else {
          audioStream = stream;
          video.style.display = 'none';
        }

        startRecognition();

        // Arama ba≈üladƒ±ktan sonra spinner gizlenir
        setTimeout(() => {
          spinner.style.display = 'none';
          status.textContent = 'G√∂r√º≈üme ba≈üladƒ±';
        }, 4000);
      }).catch(err => {
        status.textContent = 'ƒ∞zin alƒ±namadƒ±: ' + err.message;
        callActive = false;
        permissionOverlay.style.display = 'flex';
        startAudioBtn.style.display = 'inline-block';
        startVideoBtn.style.display = 'inline-block';
        endCallBtn.style.display = 'none';
      });
    }

    // ƒ∞zin verme butonuna tƒ±klayƒ±nca arama ba≈ülar
    grantPermissionBtn.onclick = () => {
      permissionOverlay.style.display = 'none';
    };

    // Ba≈ülatma butonlarƒ±
    startAudioBtn.onclick = () => {
      permissionOverlay.style.display = 'flex';
      grantPermissionBtn.onclick = () => {
        startCall(false);
        permissionOverlay.style.display = 'none';
      };
    };
    startVideoBtn.onclick = () => {
      permissionOverlay.style.display = 'flex';
      grantPermissionBtn.onclick = () => {
        startCall(true);
        permissionOverlay.style.display = 'none';
      };
    };

    endCallBtn.onclick = () => {
      endCall();
    };
  </script>
</body>
</html>
