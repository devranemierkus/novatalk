<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>NovaTalk - Akıllı Sesli & Görüntülü Asistan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      color: #2c3e50;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0;
      overflow-x: hidden;
    }
    h1 {
      color: #2980b9;
      margin-bottom: 25px;
      font-size: 2.8em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      letter-spacing: 1px;
    }
    div {
      margin-bottom: 15px;
    }
    button {
      font-size: 1.15em;
      padding: 15px 35px;
      margin: 12px;
      border-radius: 30px;
      border: none;
      background-color: #27ae60;
      color: white;
      cursor: pointer;
      min-width: 200px;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      user-select: none;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      letter-spacing: 0.8px;
      font-weight: 600;
    }
    button:hover {
      background-color: #2ecc71;
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    button.stop {
      background-color: #e74c3c;
    }
    button.stop:hover {
      background-color: #c0392b;
    }
    button#btnRequestPermissions {
      background-color: #3498db; /* Mavi tonu */
    }
    button#btnRequestPermissions:hover {
      background-color: #2980b9; /* Daha koyu mavi */
    }
    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
      opacity: 0.7;
    }
    video {
      margin-top: 30px;
      max-width: 450px;
      width: 90%;
      border-radius: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
      display: none;
      background-color: #000;
      border: 5px solid #3498db;
    }
    #status {
      margin-top: 30px;
      font-size: 1.2em;
      color: #2c3e50;
      font-weight: bold;
      min-height: 30px;
      text-shadow: 0 1px 1px rgba(255,255,255,0.5);
    }
    #log {
      margin-top: 25px;
      max-width: 450px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      background: #ecf0f1;
      padding: 20px;
      border-radius: 15px;
      font-size: 1em;
      white-space: pre-wrap;
      min-height: 120px;
      color: #34495e;
      border: 1px solid #bdc3c7;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      overflow-y: auto;
      max-height: 250px;
      text-align: left;
      line-height: 1.5;
    }
  </style>
</head>
<body>

  <h1>NovaTalk 🚀</h1>

  <div>
    <button id="btnRequestPermissions">🔐 İzinleri Al</button>
  </div>
  <div>
    <button id="btnAudioStart" disabled>🎤 Sesli Asistanı Başlat</button>
    <button id="btnAudioStop" class="stop" disabled>⏹️ Sesli Asistanı Durdur</button>
  </div>
  <div>
    <button id="btnVideoStart" disabled>📹 Görüntülü Konuşma Başlat</button>
    <button id="btnVideoStop" class="stop" disabled>⏹️ Görüntülü Konuşmayı Durdur</button>
  </div>

  <video id="video" autoplay playsinline></video>

  <div id="status"></div>
  <div id="log">Konuşma logu buraya gelecek...</div>

  <script>
    const btnRequestPermissions = document.getElementById('btnRequestPermissions');
    const btnAudioStart = document.getElementById('btnAudioStart');
    const btnAudioStop = document.getElementById('btnAudioStop');
    const btnVideoStart = document.getElementById('btnVideoStart');
    const btnVideoStop = document.getElementById('btnVideoStop');
    const video = document.getElementById('video');
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');

    let recognition = null;
    let audioStream = null;
    let videoStream = null;
    let isListening = false; // SpeechRecognition'ın manuel olarak mı, yoksa otomatik mi yeniden başlatıldığını kontrol eder.
    const RESTART_DELAY = 2000; // 2 saniye gecikme

    // Loglama fonksiyonu: Mesajları hem HTML'e hem de konsola yazdırır
    function appendToLog(message) {
      if (logDiv) {
        const now = new Date();
        const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        logDiv.textContent += `\n[${time}] ${message}`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }
      console.log(`[LOG]: ${message}`);
    }

    // Durum mesajlarını güncelleyen fonksiyon
    function updateStatus(message) {
        if (statusDiv) {
            statusDiv.textContent = message;
        }
        appendToLog(`DURUM: ${message}`);
    }

    // Botun sesli yanıt vermesini sağlayan fonksiyon
    function botSpeak(text) {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'tr-TR';
      utterance.pitch = 1;
      utterance.rate = 1;
      utterance.volume = 1;
      utterance.onend = () => {
        appendToLog("Bot konuşması bitti.");
        // Bot konuşması bittikten sonra 2 saniye bekleyip tekrar dinlemeyi başlat
        if (isListening) { // isListening true ise, yani asistan hala aktifse
            updateStatus(`NovaTalk konuşmasını bitirdi. ${RESTART_DELAY / 1000} saniye içinde tekrar dinlemeye başlayacağım...`);
            appendToLog(`Bekleniyor: ${RESTART_DELAY / 1000} saniye sonra tekrar dinleme başlayacak.`);
            setTimeout(() => {
                if (isListening && recognition && recognition.start) { // Tekrar kontrol et
                    try {
                        recognition.start();
                        updateStatus('Dinlemeye devam ediyorum... Mikrofon açık.');
                    } catch (e) {
                        appendToLog(`Bot konuşması sonrası dinleme başlatılırken hata: ${e.message}`);
                        console.error("Recognition re-start after botSpeak error:", e);
                        updateStatus('Dinleme hatası oluştu. Lütfen tekrar başlatın.');
                        isListening = false;
                        stopRecognition();
                    }
                }
            }, RESTART_DELAY);
        }
      };
      utterance.onerror = (event) => {
        appendToLog(`Bot konuşma hatası: ${event.error}`);
        console.error("SpeechSynthesis error:", event.error);
        updateStatus('Bot konuşurken hata oluştu.');
      };
      speechSynthesis.speak(utterance);
      appendToLog(`NovaTalk söyledi: ${text}`);
    }

    // Ses tanımayı başlatan fonksiyon
    function startRecognition() {
      // Tarayıcı uyumluluk kontrolü (bu kontrolü izin almadan önce de yapabiliriz)
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        updateStatus('Tarayıcınız ses tanımayı desteklemiyor! Lütfen Chrome gibi destekleyen bir tarayıcı kullanın.');
        appendToLog('Hata: Tarayıcı ses tanımayı desteklemiyor.');
        alert('Tarayıcınız ses tanımayı desteklemiyor! Lütfen Chrome gibi destekleyen bir tarayıcı kullanın.');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'tr-TR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.continuous = false; // Konuşma durduktan sonra otomatik olarak durdur

      recognition.onstart = () => {
        updateStatus('Konuşmanı dinliyorum... Mikrofonun açık.');
        appendToLog('Ses tanıma başlatıldı. Dinleniyor...');
        // isListening = true; // Bu artık başlatma butonuna basıldığında ayarlanıyor
      };

      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript.toLowerCase();
        appendToLog('Sen söyledin: "' + text + '"');
        updateStatus('Anladım: ' + text);
        botReply(text); // Botun yanıt vermesi
      };

      recognition.onerror = (event) => {
        updateStatus('Hata: ' + event.error);
        appendToLog(`Ses tanıma hatası: ${event.error}. Detay: ${event.message || 'Bilinmiyor.'}`);
        console.error("SpeechRecognition error:", event.error);

        if (event.error === 'not-allowed') {
          appendToLog('Mikrofon erişimi reddedildi. Lütfen tarayıcı ayarlarınızdan izin verin.');
          updateStatus('Mikrofon izni reddedildi. Tekrar denemek için sayfayı yenileyip izinleri yeniden alın.');
        } else if (event.error === 'no-speech') {
          appendToLog('Konuşma algılanmadı. Lütfen daha net ve yakın konuşun.');
          updateStatus('Konuşma algılanmadı. Tekrar deniyorum...');
          if(isListening) { // Eğer hala dinlemede kalması gerekiyorsa
              setTimeout(() => {
                  try {
                      recognition.start();
                  } catch (e) {
                      appendToLog(`'no-speech' sonrası tekrar başlatılırken hata: ${e.message}`);
                      console.error("Recognition restart after no-speech error:", e);
                  }
              }, 500);
          }
        } else if (event.error === 'audio-capture') {
          appendToLog('Mikrofon şu anda kullanılamıyor veya başka bir uygulama tarafından kullanılıyor.');
          updateStatus('Mikrofon hatası. Başka bir uygulama kullanıyor olabilir.');
        } else if (event.error === 'network') {
          appendToLog('Ağ bağlantı hatası. İnternet bağlantınızı kontrol edin.');
          updateStatus('Ağ hatası. Bağlantınızı kontrol edin.');
        } else if (event.error === 'aborted') {
            appendToLog('Ses tanıma işlemi iptal edildi.');
        }
        
        if (isListening && !['no-speech', 'aborted'].includes(event.error)) {
             isListening = false;
             stopRecognition();
             updateStatus('Bir hata nedeniyle asistan durduruldu.');
             setButtonStates(false, false, false, false, true); // İzin butonunu tekrar aktif et
        }
      };

      recognition.onend = () => {
        appendToLog('Ses tanıma sona erdi (onend tetiklendi).');
        // Bot konuşması sonrası otomatik yeniden başlatma botSpeak.onend içinde yönetiliyor.
        // Burada sadece dinleme devam etmiyorsa durumu güncelleriz.
        if (!isListening) {
             updateStatus('Ses tanıma durdu.');
             appendToLog('Ses tanıma kalıcı olarak durduruldu (isListening false).');
        } else if (!speechSynthesis.speaking) {
            // Eğer isListening true ise ama bot konuşmuyorsa (yani kullanıcı konuşması bitti)
            // BotSpeak içindeki gecikmeli başlatmayı bekliyoruz.
            updateStatus('Konuşma bitti. Botun yanıtı bekleniyor...');
        }
      };

      try {
        recognition.start();
      } catch (e) {
        appendToLog(`Ses tanıma başlatılırken genel hata oluştu: ${e.message}`);
        console.error("Recognition start initial error:", e);
        updateStatus('Ses tanıma başlatılamadı. Lütfen izinleri tekrar kontrol edin.');
        isListening = false;
        setButtonStates(false, false, false, false, true); // İzin butonunu tekrar aktif et
      }
    }

    // Botun kullanıcının söylediklerine verdiği yanıtlar (Konuşma Mantığı)
    function botReply(text) {
      let replyText = '';
      const now = new Date();

      if (text.includes('merhaba') || text.includes('selam')) {
        replyText = 'Merhaba! NovaTalk hizmetinizdeyim. Size nasıl yardımcı olabilirim?';
      } else if (text.includes('nasılsın')) {
        replyText = 'Ben bir yapay zekayım, iyiyim teşekkür ederim. Siz nasılsınız?';
      } else if (text.includes('adın ne') || text.includes('kimsin')) {
        replyText = 'Ben NovaTalk, dijital asistanınızım.';
      } else if (text.includes('saat kaç') || text.includes('saati söyle')) {
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        replyText = `Şu an saat ${hours}:${minutes}.`;
      } else if (text.includes('bugün günlerden ne') || text.includes('tarih ne')) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        replyText = `Bugün ${now.toLocaleDateString('tr-TR', options)}.`;
      } else if (text.includes('yardım et') || text.includes('ne yapabilirsin')) {
        replyText = 'Size saati söyleyebilir, günün tarihini belirtebilir veya sadece sohbet edebilirim. Ne sormak istersiniz?';
      } else if (text.includes('güle güle') || text.includes('görüşürüz') || text.includes('kapat') || text.includes('bitir')) {
        replyText = 'Görüşmek üzere! Kendinize iyi bakın.';
        isListening = false; // Kapatma komutunda dinlemeyi durdur
        setTimeout(() => stopAll(), 1500); // Bot konuşmayı bitirdikten sonra kapat
      } else {
        const randomReplies = [
          'Üzgünüm, dediğinizi tam anlayamadım. Tekrar söyler misiniz?',
          'Lütfen daha net konuşur musunuz?',
          'Kusura bakmayın, anlayamadım. Ne demek istediniz?',
          'Tekrar edebilir misiniz?'
        ];
        replyText = randomReplies[Math.floor(Math.random() * randomReplies.length)];
      }
      botSpeak(replyText);
    }

    // Ses tanımayı durduran fonksiyon
    function stopRecognition() {
      if(recognition) {
        isListening = false; // Dinlemeyi tamamen kapat
        recognition.stop();
        appendToLog('Ses tanıma durdurma komutu gönderildi.');
      }
      recognition = null; // Recognition objesini sıfırla
    }

    // Kamera ve mikrofon akışlarını durduran fonksiyon
    function stopStreams() {
      if(audioStream) {
        audioStream.getTracks().forEach(t => t.stop());
        audioStream = null;
        appendToLog('Ses akışı durduruldu.');
      }
      if(videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
        video.srcObject = null;
        appendToLog('Video akışı durduruldu.');
      }
      video.style.display = 'none';
    }

    // Tüm aktif işlemleri durduran ana fonksiyon
    function stopAll() {
      appendToLog('Tüm konuşma ve akışlar sonlandırılıyor...');
      stopRecognition();
      stopStreams();
      updateStatus('Konuşma sonlandırıldı. Tekrar başlatmak için izinleri alıp düğmelere tıklayın.');
      appendToLog('NovaTalk tamamen sonlandırıldı.');
      setButtonStates(false, false, false, false, true); // İzin butonunu tekrar aktif et
    }

    // Butonların durumunu ayarlayan yardımcı fonksiyon
    function setButtonStates(audioStart, audioStop, videoStart, videoStop, requestPermissions) {
        btnAudioStart.disabled = !audioStart;
        btnAudioStop.disabled = !audioStop;
        btnVideoStart.disabled = !videoStart;
        btnVideoStop.disabled = !videoStop;
        btnRequestPermissions.disabled = !requestPermissions;
    }

    // Sayfa yüklendiğinde başlangıç log mesajını ve durumu göster
    appendToLog("NovaTalk hazır. Lütfen 'İzinleri Al' düğmesine tıklayarak başlayın.");
    updateStatus("Hoş geldiniz! İzinleri alarak başlayın.");
    setButtonStates(false, false, false, false, true); // İlk başta sadece izin butonu aktif


    // İzinleri Al düğmesine tıklama olayı
    btnRequestPermissions.onclick = () => {
        appendToLog('İzinler isteniyor...');
        updateStatus('Mikrofon ve kamera izinleri bekleniyor...');
        // Her iki izni de aynı anda isteyelim ki sonra sorun olmasın
        navigator.mediaDevices.getUserMedia({ audio: true, video: true })
            .then(stream => {
                // İzinler başarılı bir şekilde alındı, akışları hemen kullanmıyoruz
                // Sadece izinlerin alındığını kontrol etmek için
                stream.getTracks().forEach(t => t.stop()); // Akışları hemen durdur
                appendToLog('Kamera ve mikrofon izinleri başarıyla alındı.');
                updateStatus('İzinler alındı. Sesli veya Görüntülü Asistanı başlatabilirsiniz.');
                setButtonStates(true, false, true, false, false); // Başlatma butonlarını aktif et, izin butonunu pasif et
            })
            .catch(err => {
                appendToLog('İzin alma hatası: ' + err.name + " - " + err.message);
                console.error("Permission request error:", err);
                updateStatus('İzinler reddedildi veya bir hata oluştu. Lütfen tarayıcı ayarlarınızı kontrol edin.');
                setButtonStates(false, false, false, false, true); // İzin butonunu tekrar aktif et
                alert('Mikrofon veya kamera izni reddedildi. Uygulamanın çalışması için izin vermeniz gerekiyor.');
            });
    };


    // Sesli Konuşma Başlat düğmesine tıklama olayı
    btnAudioStart.onclick = () => {
      stopAll(); // Önceki tüm işlemleri durdur
      appendToLog('Sesli asistan başlatma isteği.');
      updateStatus('Mikrofon başlatılıyor...');

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          audioStream = stream;
          video.style.display = 'none';
          updateStatus('Sesli asistan başlatıldı. Dinliyorum...');
          appendToLog('Mikrofon akışı alındı. Ses tanıma başlatılıyor.');

          setButtonStates(false, true, false, false, false); // Sesli başlat pasif, durdur aktif, diğerleri pasif

          isListening = true; // Dinleme durumunu aktif et
          startRecognition(); // Ses tanımayı başlat
        })
        .catch(err => {
          updateStatus('Mikrofon başlatma hatası: ' + err.message);
          appendToLog('Hata: Mikrofon akışı başlatılamadı. Detay: ' + err.name + " - " + err.message);
          console.error("getUserMedia (audio) error:", err);
          stopAll();
          alert('Mikrofon başlatılamadı. Başka bir uygulama kullanıyor olabilir.');
        });
    };

    // Sesli Konuşmayı Durdur düğmesine tıklama olayı
    btnAudioStop.onclick = () => {
      stopAll();
      appendToLog('Sesli asistan durduruldu.');
    };

    // Görüntülü Konuşma Başlat düğmesine tıklama olayı
    btnVideoStart.onclick = () => {
      stopAll();
      appendToLog('Görüntülü konuşma başlatma isteği.');
      updateStatus('Kamera ve mikrofon başlatılıyor...');

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.style.display = 'block';
          updateStatus('Görüntülü konuşma başlatıldı. Dinliyorum...');
          appendToLog('Kamera ve mikrofon akışı alındı. Ses tanıma başlatılıyor.');

          setButtonStates(false, false, false, true, false); // Görüntülü başlat pasif, durdur aktif, diğerleri pasif
          
          isListening = true; // Dinleme durumunu aktif et
          startRecognition();
        })
        .catch(err => {
          updateStatus('Kamera veya mikrofon başlatma hatası: ' + err.message);
          appendToLog('Hata: Kamera veya mikrofon akışı başlatılamadı. Detay: ' + err.name + " - " + err.message);
          console.error("getUserMedia (video+audio) error:", err);
          stopAll();
          alert('Kamera veya mikrofon başlatılamadı. Başka bir uygulama kullanıyor olabilir.');
        });
    };

    // Görüntülü Konuşmayı Durdur düğmesine tıklama olayı
    btnVideoStop.onclick = () => {
      stopAll();
      appendToLog('Görüntülü konuşma durduruldu.');
    };
  </script>

</body>
</html>
