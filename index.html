<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>NovaTalk - Sesli & G√∂r√ºnt√ºl√º Konu≈üma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #eee;
      text-align: center;
      padding: 30px;
    }
    h1 {
      color: #4caf50;
      margin-bottom: 20px;
    }
    button {
      font-size: 18px;
      margin: 12px 10px;
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      min-width: 180px;
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #btnVoice {
      background: #2196f3;
    }
    #btnVoice:hover {
      background: #1769aa;
    }
    #btnVideoStart {
      background: #ff9800;
      color: #222;
    }
    #btnVideoStart:hover {
      background: #cc7a00;
    }
    #btnVideoStop {
      background: #f44336;
    }
    #btnVideoStop:hover {
      background: #b71c1c;
    }
    video {
      margin-top: 25px;
      border-radius: 16px;
      max-width: 360px;
      width: 90%;
      display: none;
      border: 3px solid #4caf50;
      box-shadow: 0 0 15px #4caf50;
    }
    #status {
      margin-top: 18px;
      font-size: 18px;
      min-height: 28px;
    }
    #log {
      margin: 20px auto 0 auto;
      background: #222;
      padding: 16px;
      max-width: 360px;
      border-radius: 14px;
      white-space: pre-wrap;
      height: 140px;
      overflow-y: auto;
      font-size: 16px;
      color: #eee;
      border: 2px solid #4caf50;
      box-shadow: inset 0 0 10px #333;
      text-align: left;
    }
  </style>
</head>
<body>

  <h1>NovaTalk ü§ñ</h1>

  <button id="btnVoice" disabled>üé§ Sesli Konu≈ümayƒ± Ba≈ülat</button>
  <button id="btnVideoStart" disabled>üìπ G√∂r√ºnt√ºl√º Konu≈ümayƒ± Ba≈ülat</button>
  <button id="btnVideoStop" disabled>‚èπÔ∏è G√∂r√ºnt√ºl√º Konu≈ümayƒ± Durdur</button>

  <video id="video" autoplay playsinline></video>

  <div id="status">Durum: ƒ∞zinler isteniyor...</div>
  <div id="log">üìù Konu≈üma logu buraya gelecek...</div>

  <script>
    const btnVoice = document.getElementById('btnVoice');
    const btnVideoStart = document.getElementById('btnVideoStart');
    const btnVideoStop = document.getElementById('btnVideoStop');
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const log = document.getElementById('log');

    let recognition = null;
    let audioStream = null;
    let videoStream = null;
    let listening = false;
    let idleTimer = null;
    const idleTimeout = 5000; // 5 saniye bo≈üta kalƒ±nca uyarƒ±
    let idleUyariVerildi = false; // sadece 1 kere uyarƒ± i√ßin flag

    // Sesli bot konu≈üma fonksiyonu - optimize ses
    function botKonus(text) {
      try {
        if (speechSynthesis.speaking) speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'tr-TR';
        utterance.pitch = 1.3;  // daha net ve doƒüal ses
        utterance.rate = 0.95;  // biraz daha yava≈ü
        utterance.volume = 1.0;

        utterance.onerror = (e) => {
          status.textContent = 'DURUM: ChatNova konu≈üma hatasƒ± olu≈ütu.';
          console.error('TTS Error:', e.error);
        };

        speechSynthesis.speak(utterance);
      } catch (e) {
        status.textContent = 'DURUM: ChatNova konu≈üma fonksiyonunda hata.';
        console.error(e);
      }
    }

    function resetIdleTimer() {
      if (idleTimer) clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        if(!idleUyariVerildi) {
          botKonus('Konu≈ümayƒ± bekliyorum dostum...');
          log.textContent += '\nü§ñ ChatNova: Konu≈ümayƒ± bekliyorum dostum...';
          log.scrollTop = log.scrollHeight;
          idleUyariVerildi = true;
        }
        // sonra tekrar etme, sadece 1 kere uyarƒ± yeterli
      }, idleTimeout);
    }

    // Konu≈üma ba≈ülat
    function startRecognition() {
      if (listening) return;

      navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        audioStream = stream;

        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'tr-TR';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onresult = (event) => {
          idleUyariVerildi = false; // Konu≈üunca tekrar uyarƒ± verilebilir hale getir
          resetIdleTimer();

          const speech = event.results[event.results.length -1][0].transcript.toLowerCase();
          log.textContent += `\nüë§ Sen: ${speech}`;
          log.scrollTop = log.scrollHeight;
          botCevapVer(speech);
        };

        recognition.onerror = (event) => {
          status.textContent = `‚ö†Ô∏è Ses tanƒ±ma hatasƒ±: ${event.error}`;
        };

        recognition.onend = () => {
          if (listening) recognition.start();
          else status.textContent = 'Durum: Sesli konu≈üma kapandƒ±.';
        };

        recognition.start();
        listening = true;
        btnVoice.textContent = 'üõë Sesli Konu≈ümayƒ± Durdur';
        status.textContent = 'Durum: Selam! Seni dinliyorum... üéß';
        botKonus('Selam! Seni dinliyorum...');
        resetIdleTimer();
      })
      .catch(err => {
        status.textContent = '‚ùå Mikrofon izni reddedildi veya hata: ' + err.message;
      });
    }

    // Konu≈ümayƒ± durdur
    function stopRecognition() {
      listening = false;
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
      status.textContent = 'Durum: Sesli konu≈üma durduruldu.';
      if (idleTimer) clearTimeout(idleTimer);
      idleUyariVerildi = false;
      btnVoice.textContent = 'üé§ Sesli Konu≈ümayƒ± Ba≈ülat';
    }

    // Basit bot cevabƒ±
    function botCevapVer(text) {
      let cevap = '';
      if (text.includes('nasƒ±lsƒ±n')) cevap = 'ƒ∞yiyim, te≈üekk√ºr ederim! Sen nasƒ±lsƒ±n?';
      else if (text.includes('merhaba')) cevap = 'Merhaba! Sana nasƒ±l yardƒ±mcƒ± olabilirim?';
      else if (text.includes('g√∂r√º≈ü√ºr√ºz')) {
        cevap = 'G√∂r√º≈ümek √ºzere! ƒ∞yi g√ºnler!';
        stopRecognition();
      }
      else cevap = '√úzg√ºn√ºm, bunu anlayamadƒ±m. L√ºtfen tekrar eder misin?';

      log.textContent += `\nü§ñ ChatNova: ${cevap}`;
      log.scrollTop = log.scrollHeight;
      botKonus(cevap);
    }

    // G√∂r√ºnt√ºl√º konu≈üma ba≈ülat
    function startVideo() {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        videoStream = stream;
        video.srcObject = stream;
        video.style.display = 'block';

        btnVideoStart.disabled = true;
        btnVideoStop.disabled = false;

        status.textContent = 'Durum: G√∂r√ºnt√ºl√º konu≈üma ba≈üladƒ±.';
        log.textContent += '\nüìπ G√∂r√ºnt√ºl√º konu≈üma ba≈üladƒ±.';
      })
      .catch(err => {
        status.textContent = '‚ùå Kamera veya mikrofon izni reddedildi: ' + err.message;
      });
    }

    // G√∂r√ºnt√ºl√º konu≈ümayƒ± durdur
    function stopVideo() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        video.style.display = 'none';

        btnVideoStart.disabled = false;
        btnVideoStop.disabled = true;

        status.textContent = 'Durum: G√∂r√ºnt√ºl√º konu≈üma durduruldu.';
        log.textContent += '\n‚èπÔ∏è G√∂r√ºnt√ºl√º konu≈üma durduruldu.';
      }
    }

    // Sayfa y√ºklendiƒüinde izinleri otomatik iste
    async function izinIste() {
      status.textContent = 'Durum: ƒ∞zinler isteniyor...';

      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        btnVoice.disabled = false;
        status.textContent = '‚úÖ Mikrofon izni verildi. Sesli konu≈ümayƒ± ba≈ülatabilirsin.';
      } catch {
        status.textContent = '‚ùå Mikrofon izni reddedildi.';
      }

      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        btnVideoStart.disabled = false;
        status.textContent += ' ‚úÖ Kamera izni verildi. G√∂r√ºnt√ºl√º konu≈ümayƒ± ba≈ülatabilirsin.';
      } catch {
        status.textContent += ' ‚ùå Kamera izni reddedildi.';
      }
    }

    btnVoice.onclick = () => {
      if (listening) stopRecognition();
      else startRecognition();
    };

    btnVideoStart.onclick = () => startVideo();
    btnVideoStop.onclick = () => stopVideo();

    // Sayfa a√ßƒ±lƒ±r a√ßƒ±lmaz izin iste ve butonlarƒ± aktif et
    window.onload = () => {
      izinIste();
      btnVideoStop.disabled = true;
    }
  </script>

</body>
</html>
