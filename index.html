<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaTalk - Sesli & Görüntülü Arama</title>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif; background: #ece5dd;
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      background: #075e54; color: white; padding: 16px; font-size: 24px; text-align: center;
    }
    #callScreen {
      display: none; flex-direction: column; align-items: center; justify-content: center;
      flex-grow: 1; background: #128c7e; color: white; text-align: center; padding: 20px; position: relative;
    }
    #spinner {
      border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid white;
      border-radius: 50%;
      width: 60px; height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    #video {
      width: 90%; max-width: 400px; margin-top: 20px;
      border-radius: 12px; display: none;
    }
    #log {
      background: white; margin: 10px; padding: 10px; border-radius: 8px;
      height: 150px; overflow-y: auto; white-space: pre-wrap;
      flex-shrink: 0; font-size: 14px; color: #333;
    }
    footer {
      background: #f0f0f0; padding: 15px; display: flex;
      justify-content: space-around; flex-shrink: 0;
    }
    button {
      padding: 12px 20px; font-size: 16px; border: none; border-radius: 30px;
      cursor: pointer; user-select: none; transition: background-color 0.3s;
      min-width: 130px;
    }
    #startAudioBtn { background: #25d366; color: white; }
    #startVideoBtn { background: #34b7f1; color: white; }
    #endCallBtn { background: #dc3545; color: white; display: none; }
    #status { font-size: 18px; margin-bottom: 10px; min-height: 1.5em; }
    #statusMsg { margin-top: 5px; font-style: italic; }
    #permissionMsg {
      background: #fff3cd; color: #856404; padding: 10px;
      border-radius: 8px; margin: 10px auto; max-width: 400px; display: none;
      font-size: 14px; text-align: center;
    }
    #securityNote {
      font-size: 12px; color: #666; margin-top: 5px;
      max-width: 400px; margin-left: auto; margin-right: auto;
    }
  </style>
</head>
<body>

<header>NovaTalk</header>

<div id="permissionMsg"></div>

<div id="callScreen">
  <div id="spinner"></div>
  <div id="status">ChatNova aranıyor...</div>
  <video id="video" autoplay playsinline muted></video>
  <div id="statusMsg"></div>
</div>

<div id="log">📝 Konuşmalar buraya yazılacak...</div>
<div id="securityNote">
  Güvenlik Notu: Uygulama sadece sizin mikrofon ve kameranızı kullanır. Başkası sizi dinleyemez veya göremez.
</div>

<footer>
  <button id="startAudioBtn">🎤 Sesli Arama</button>
  <button id="startVideoBtn">📹 Görüntülü Arama</button>
  <button id="endCallBtn">🔴 Aramayı Bitir</button>
</footer>

<script>
  const permissionMsg = document.getElementById('permissionMsg');
  const callScreen = document.getElementById('callScreen');
  const spinner = document.getElementById('spinner');
  const status = document.getElementById('status');
  const statusMsg = document.getElementById('statusMsg');
  const video = document.getElementById('video');
  const log = document.getElementById('log');
  const startAudioBtn = document.getElementById('startAudioBtn');
  const startVideoBtn = document.getElementById('startVideoBtn');
  const endCallBtn = document.getElementById('endCallBtn');

  let recognition;
  let inactivityTimer;
  let callActive = false;
  let audioStream = null;
  let videoStream = null;
  let botHasGreeted = false;

  // İzin kontrol fonksiyonu - mikrofon izni
  async function checkMicrophonePermission() {
    if (!navigator.permissions) return true; // destek yoksa izin iste
    try {
      const status = await navigator.permissions.query({ name: 'microphone' });
      return status.state === 'granted';
    } catch {
      return true; // hata varsa izin iste
    }
  }

  // İzin kontrol fonksiyonu - kamera izni
  async function checkCameraPermission() {
    if (!navigator.permissions) return true;
    try {
      const status = await navigator.permissions.query({ name: 'camera' });
      return status.state === 'granted';
    } catch {
      return true;
    }
  }

  function speak(text) {
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
    }
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'tr-TR';
    utterance.pitch = 1.1;
    utterance.rate = 1;
    speechSynthesis.speak(utterance);
  }

  function logMessage(text) {
    log.textContent += '\n' + text;
    log.scrollTop = log.scrollHeight;
  }

  function resetInactivity() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      speak('Dostum, konuşmuyorsun. Kapatmak zorundayım.');
      logMessage('🔴 Otomatik kapanma: Konuşma algılanmadı.');
      endCall();
    }, 15000);
  }

  function stopStreams() {
    if (audioStream) {
      audioStream.getTracks().forEach(t => t.stop());
      audioStream = null;
    }
    if (videoStream) {
      videoStream.getTracks().forEach(t => t.stop());
      videoStream = null;
    }
  }

  function handleStreamEnd() {
    speak('Mikrofon ya da kamera kapandı, arama sonlandırılıyor.');
    logMessage('🔴 Arama otomatik kapandı, mikrofon veya kamera kapandı.');
    endCall();
  }

  function startRecognition() {
    if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
      alert('Tarayıcınız ses tanımayı desteklemiyor!');
      return;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'tr-TR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      statusMsg.textContent = '🎤 Dinleniyor...';
      if (!botHasGreeted) {
        speak('Selam! Seni dinliyorum.');
        botHasGreeted = true;
      }
    };

    recognition.onresult = (event) => {
      const userSpeech = event.results[0][0].transcript;
      logMessage('👤 Sen: ' + userSpeech);
      botRespond(userSpeech.toLowerCase());
      resetInactivity();
    };

    recognition.onerror = (event) => {
      statusMsg.textContent = 'Ses tanıma hatası: ' + event.error;
    };

    recognition.onend = () => {
      if (callActive) {
        recognition.start();
      }
    };

    recognition.start();
    resetInactivity();
  }

  function botRespond(text) {
    let response = '';

    if (text.includes('nasılsın')) {
      response = 'İyiyim, teşekkür ederim! Sen nasılsın?';
    } else if (text.includes('merhaba')) {
      response = 'Merhaba! Sana nasıl yardımcı olabilirim?';
    } else if (text.includes('görüşürüz') || text.includes('hoşça kal')) {
      response = 'Görüşmek üzere! İyi günler!';
      logMessage('🤖 ChatNova: ' + response);
      speak(response);
      endCall();
      return;
    } else {
      response = 'Üzgünüm, bunu anlayamadım. Lütfen tekrar eder misin?';
    }

    logMessage('🤖 ChatNova: ' + response);
    speak(response);
  }

  function endCall() {
    callActive = false;
    clearTimeout(inactivityTimer);
    if (recognition) {
      recognition.stop();
      recognition = null;
    }
    stopStreams();
    video.style.display = 'none';
    callScreen.style.display = 'none';
    statusMsg.textContent = '';
    status.textContent = '';
    spinner.style.display = 'none';
    startAudioBtn.style.display = 'inline-block';
    startVideoBtn.style.display = 'inline-block';
    endCallBtn.style.display = 'none';
    botHasGreeted = false;
    logMessage('🔴 Görüşme sonlandırıldı.');
  }

  function showPermissionMessage(text) {
    permissionMsg.textContent = text;
    permissionMsg.style.display = 'block';
  }

  function clearPermissionMessage() {
    permissionMsg.style.display = 'none';
    permissionMsg.textContent = '';
  }

  async function startCall(withVideo = false) {
    if (callActive) return;

    clearPermissionMessage();
    callActive = true;
    botHasGreeted = false;
    showCallingScreen();

    startAudioBtn.style.display = 'none';
    startVideoBtn.style.display = 'none';
    endCallBtn.style.display = 'inline-block';

    setTimeout(async () => {
      spinner.style.display = 'none';
      status.textContent = 'Görüşme başladı';

      // İzin kontrol ve bilgilendirme:
      if (withVideo) {
        // Görüntülü arama: mikrofon + kamera izni kontrolü
        const micGranted = await checkMicrophonePermission();
        const camGranted = await checkCameraPermission();

        if (!micGranted || !camGranted) {
          showPermissionMessage('NovaTalk mikrofon ve kameranıza erişmek istiyor. Lütfen izin verin.');
        }

        navigator.mediaDevices.getUserMedia({ audio: true, video: true })
          .then(stream => {
            clearPermissionMessage();

            stream.getTracks().forEach(track => {
              track.onended = () => handleStreamEnd();
            });

            videoStream = stream;
            video.srcObject = stream;
            video.style.display = 'block';
            audioStream = new MediaStream(stream.getAudioTracks());

            startRecognition();
          })
          .catch(err => {
            clearPermissionMessage();
            status.textContent = 'İzin alınamadı: ' + err.message;
            logMessage('⚠️ İzin reddedildi veya hata oluştu: ' + err.message);
            endCall();
          });
      } else {
        // Sadece sesli arama: sadece mikrofon izni kontrolü
        const micGranted = await checkMicrophonePermission();

        if (!micGranted) {
          showPermissionMessage('NovaTalk mikrofonunuza erişmek istiyor. Lütfen izin verin.');
        }

        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            clearPermissionMessage();

            stream.getTracks().forEach(track => {
              track.onended = () => handleStreamEnd();
            });

            audioStream = stream;
            video.style.display = 'none';

            startRecognition();
          })
          .catch(err => {
            clearPermissionMessage();
            status.textContent = 'İzin alınamadı: ' + err.message;
            logMessage('⚠️ İzin reddedildi veya hata oluştu: ' + err.message);
            endCall();
          });
      }
    }, 4000);
  }

  function showCallingScreen() {
    callScreen.style.display = 'flex';
    spinner.style.display = 'block';
    status.textContent = 'ChatNova aranıyor...';
    statusMsg.textContent = '';
  }

  // Button eventleri
  startAudioBtn.onclick = () => startCall(false);
  startVideoBtn.onclick = () => startCall(true);
  endCallBtn.onclick = endCall;

</script>

</body>
</html>
