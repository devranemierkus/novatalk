<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NovaTalk - Sesli & G√∂r√ºnt√ºl√º Chatbot</title>
<style>
  /* Temiz, modern, WhatsApp stilinde basit tasarƒ±m */
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #e5ddd5;
    display: flex; flex-direction: column;
    height: 100vh;
    align-items: center;
    justify-content: flex-start;
  }
  header {
    background: #075e54;
    color: white;
    width: 100%;
    padding: 15px 20px;
    font-size: 22px;
    font-weight: 600;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  #chat {
    flex: 1;
    width: 100%;
    max-width: 480px;
    background: #fff;
    padding: 15px;
    overflow-y: auto;
    box-sizing: border-box;
  }
  .message {
    margin: 8px 0;
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 20px;
    position: relative;
    font-size: 16px;
    line-height: 1.3;
  }
  .user {
    background: #dcf8c6;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }
  .bot {
    background: #f1f0f0;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }

  /* Avatar ve aƒüƒ±z animasyonu */
  #avatar {
    width: 100px; height: 100px;
    background: #128c7e;
    border-radius: 50%;
    margin: 20px 0 10px 0;
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  }
  .eye {
    position: absolute;
    background: white;
    width: 20px; height: 20px;
    border-radius: 50%;
    top: 30px;
    box-shadow: inset 0 0 3px #333;
  }
  .eye.left { left: 25px; }
  .eye.right { right: 25px; }
  .pupil {
    background: #004d40;
    width: 10px; height: 10px;
    border-radius: 50%;
    position: absolute;
    top: 5px; left: 5px;
    transition: transform 0.3s ease;
  }
  #mouth {
    position: absolute;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px; height: 24px;
    background: #004d40;
    border-radius: 0 0 30px 30px;
    transition: height 0.15s ease;
  }

  /* Kontrol √ßubuƒüu */
  #controls {
    width: 100%;
    max-width: 480px;
    background: #fff;
    padding: 15px;
    box-sizing: border-box;
    display: flex;
    gap: 10px;
    justify-content: center;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  }
  button {
    background: #075e54;
    border: none;
    color: white;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 30px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: #128c7e;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Video container */
  #videoContainer {
    display: none;
    margin-top: 10px;
    max-width: 480px;
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 3px 15px rgba(0,0,0,0.2);
  }
  video {
    width: 100%;
    height: auto;
  }

  /* Status text */
  #status {
    text-align: center;
    margin: 8px 0 12px 0;
    font-size: 14px;
    color: #333;
  }
</style>
</head>
<body>

<header>NovaTalk - Sesli & G√∂r√ºnt√ºl√º Chatbot</header>

<div id="avatar">
  <div class="eye left"><div class="pupil"></div></div>
  <div class="eye right"><div class="pupil"></div></div>
  <div id="mouth"></div>
</div>

<div id="chat"></div>

<div id="status">Mikrofon izni bekleniyor...</div>

<div id="controls">
  <button id="speakBtn">üé§ Bas & Konu≈ü</button>
  <button id="callBtn">üìû Sesli Arama</button>
  <button id="videoCallBtn">üìπ G√∂r√ºnt√ºl√º Arama</button>
  <button id="endCallBtn" disabled>‚ùå Kapat</button>
</div>

<div id="videoContainer">
  <video id="localVideo" autoplay muted playsinline></video>
</div>

<script>
  // --- Ayarlar ---
  const OPENAI_API_KEY = 'sk-xxx'; // Buraya kendi OpenAI API anahtarƒ±nƒ± ekle

  // --- Elementler ---
  const chat = document.getElementById('chat');
  const statusText = document.getElementById('status');
  const speakBtn = document.getElementById('speakBtn');
  const callBtn = document.getElementById('callBtn');
  const videoCallBtn = document.getElementById('videoCallBtn');
  const endCallBtn = document.getElementById('endCallBtn');
  const mouth = document.getElementById('mouth');
  const videoContainer = document.getElementById('videoContainer');
  const localVideo = document.getElementById('localVideo');

  // --- Deƒüi≈ükenler ---
  let recognition;
  let isListening = false;
  let localStream = null;
  let callActive = false;

  // --- Yardƒ±mcƒ± Fonksiyonlar ---
  function addMessage(text, sender) {
    const div = document.createElement('div');
    div.classList.add('message', sender);
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function animateMouth(open) {
    mouth.style.height = open ? '45px' : '25px';
  }

  function animatePupils() {
    const pupils = document.querySelectorAll('.pupil');
    pupils.forEach(p => {
      const x = Math.random() * 6 - 3;
      const y = Math.random() * 6 - 3;
      p.style.transform = `translate(${x}px, ${y}px)`;
    });
  }
  setInterval(animatePupils, 1500);

  // --- Mikrofon ƒ∞zni ve Konu≈üma Tanƒ±ma Ba≈ülat ---
  async function initMic() {
    try {
      await navigator.mediaDevices.getUserMedia({ audio: true });
      statusText.textContent = "üé§ Mikrofon izni verildi. Basƒ±lƒ± tutup konu≈üun.";
      speakBtn.disabled = false;
    } catch (err) {
      statusText.textContent = "‚ùå Mikrofon izni reddedildi.";
      speakBtn.disabled = true;
    }
  }
  initMic();

  // --- SpeechRecognition Kurulumu ---
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'tr-TR';
    recognition.interimResults = false;

    recognition.onstart = () => {
      isListening = true;
      animateMouth(true);
      statusText.textContent = "üéß Dinleniyor...";
    };

    recognition.onresult = async (event) => {
      const userText = event.results[0][0].transcript.trim();
      addMessage(userText, 'user');
      statusText.textContent = "Yanƒ±t hazƒ±rlanƒ±yor...";
      animateMouth(false);

      // OpenAI API √ßaƒürƒ±sƒ±
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [{ role: 'user', content: userText }],
            temperature: 0.7
          })
        });
        const data = await response.json();
        if (data.choices && data.choices.length > 0) {
          const botReply = data.choices[0].message.content.trim();
          addMessage(botReply, 'bot');
          speak(botReply);
        } else {
          addMessage("√úzg√ºn√ºm, anlayamadƒ±m.", 'bot');
        }
      } catch (error) {
        addMessage("API ile baƒülantƒ± hatasƒ±.", 'bot');
      }
    };

    recognition.onerror = (event) => {
      statusText.textContent = `Hata: ${event.error}`;
      animateMouth(false);
    };

    recognition.onend = () => {
      isListening = false;
      animateMouth(false);
      statusText.textContent = "Basƒ±lƒ± tutup konu≈üun.";
    };

  } else {
    statusText.textContent = "Tarayƒ±cƒ±nƒ±z ses tanƒ±mayƒ± desteklemiyor.";
    speakBtn.disabled = true;
  }

  // --- Sesli Konu≈üma Ba≈ülat / Durdur ---
  speakBtn.addEventListener('touchstart', () => {
    if (recognition && !isListening) {
      recognition.start();
    }
  });
  speakBtn.addEventListener('touchend', () => {
    if (recognition && isListening) {
      recognition.stop();
      statusText.textContent = "Yanƒ±t hazƒ±rlanƒ±yor...";
    }
  });

  // --- Text-to-Speech ---
  function speak(text) {
    if (!text) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'tr-TR';
    utter.rate = 1;
    utter.pitch = 1;

    utter.onstart = () => animateMouth(true);
    utter.onend = () => {
      animateMouth(false);
      statusText.textContent = "Basƒ±lƒ± tutup konu≈üun.";
    };
    speechSynthesis.speak(utter);
  }

  // --- Sesli Arama Sim√ºlasyonu ---
  callBtn.onclick = async () => {
    if (callActive) return;
    alert("Sesli arama ba≈ülatƒ±lƒ±yor (sim√ºlasyon)");
    statusText.textContent = "üìû Sesli arama aktif";
    callActive = true;
    endCallBtn.disabled = false;
  };

  // --- G√∂r√ºnt√ºl√º Arama Ba≈ülat ---
  videoCallBtn.onclick = async () => {
    if (callActive) return;
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      videoContainer.style.display = 'block';
      statusText.textContent = "üìπ G√∂r√ºnt√ºl√º arama aktif";
      callActive = true;
      endCallBtn.disabled = false;
    } catch (err) {
      alert("Kamera ve mikrofon eri≈üimi reddedildi.");
    }
  };

  // --- Aramayƒ± Sonlandƒ±r ---
  endCallBtn.onclick = () => {
    if (!callActive) return;
    if(localStream){
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    localVideo.srcObject = null;
    videoContainer.style.display = 'none';
    statusText.textContent = "‚ùå Arama sonlandƒ±rƒ±ldƒ±";
    callActive = false;
    endCallBtn.disabled = true;
  };
</script>
</body>
</html>
