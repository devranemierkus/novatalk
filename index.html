<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>NovaTalk - Sesli & Görüntülü Konuşma & İzin İste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #eee;
      text-align: center;
      padding: 30px;
    }
    h1 {
      color: #4caf50;
      margin-bottom: 20px;
    }
    button {
      font-size: 18px;
      margin: 12px 10px;
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      min-width: 180px;
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #btnMicPermission {
      background: #007bff;
    }
    #btnMicPermission:hover {
      background: #0056b3;
    }
    #btnCamPermission {
      background: #17a2b8;
    }
    #btnCamPermission:hover {
      background: #0f6674;
    }
    #btnVoice {
      background: #2196f3;
    }
    #btnVoice:hover {
      background: #1769aa;
    }
    #btnVideoStart {
      background: #ff9800;
      color: #222;
    }
    #btnVideoStart:hover {
      background: #cc7a00;
    }
    #btnVideoStop {
      background: #f44336;
    }
    #btnVideoStop:hover {
      background: #b71c1c;
    }
    video {
      margin-top: 25px;
      border-radius: 16px;
      max-width: 360px;
      width: 90%;
      display: none;
      border: 3px solid #4caf50;
      box-shadow: 0 0 15px #4caf50;
    }
    #status {
      margin-top: 18px;
      font-size: 18px;
      min-height: 28px;
    }
    #log {
      margin: 20px auto 0 auto;
      background: #222;
      padding: 16px;
      max-width: 360px;
      border-radius: 14px;
      white-space: pre-wrap;
      height: 140px;
      overflow-y: auto;
      font-size: 16px;
      color: #eee;
      border: 2px solid #4caf50;
      box-shadow: inset 0 0 10px #333;
      text-align: left;
    }
  </style>
</head>
<body>

  <h1>NovaTalk 🤖</h1>

  <!-- İzin Butonları -->
  <button id="btnMicPermission">🎤 Mikrofon İzni Ver</button>
  <button id="btnCamPermission">📷 Kamera İzni Ver</button>
  
  <br/>

  <!-- Konuşma Butonları -->
  <button id="btnVoice" disabled>🎤 Sesli Konuşmayı Başlat</button>
  <button id="btnVideoStart" disabled>📹 Görüntülü Konuşmayı Başlat</button>
  <button id="btnVideoStop" disabled>⏹️ Görüntülü Konuşmayı Durdur</button>

  <video id="video" autoplay playsinline></video>

  <div id="status">Durum: İzinler bekleniyor...</div>
  <div id="log">📝 Konuşma logu buraya gelecek...</div>

  <script>
    const btnMicPermission = document.getElementById('btnMicPermission');
    const btnCamPermission = document.getElementById('btnCamPermission');
    const btnVoice = document.getElementById('btnVoice');
    const btnVideoStart = document.getElementById('btnVideoStart');
    const btnVideoStop = document.getElementById('btnVideoStop');
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const log = document.getElementById('log');

    let micPermissionGranted = false;
    let camPermissionGranted = false;

    let recognition = null;
    let audioStream = null;
    let videoStream = null;
    let listening = false;

    let idleTimer = null;
    const idleTimeout = 5000; // 5 saniye boşta kalınca uyarı

    function resetIdleTimer() {
      if (idleTimer) clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        botKonus('Konuş, bekliyorum dostum 😊');
        log.textContent += '\n🤖 Bot: Konuş, bekliyorum dostum 😊';
        log.scrollTop = log.scrollHeight;
        resetIdleTimer();
      }, idleTimeout);
    }

    function botKonus(text) {
      try {
        if (speechSynthesis.speaking) {
          speechSynthesis.cancel();
        }
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'tr-TR';
        utterance.pitch = 1.1;
        utterance.rate = 1;
        utterance.onerror = (event) => {
          status.textContent = 'DURUM: Bot konuşurken hata oluştu. Lütfen konsolu kontrol edin.';
          console.error('SpeechSynthesisUtterance error:', event.error);
        };
        speechSynthesis.speak(utterance);
      } catch (e) {
        status.textContent = 'DURUM: Bot konuşma fonksiyonunda hata oluştu.';
        console.error('botKonus error:', e);
      }
    }

    // İzinleri kontrol ve buton aktif et
    function checkEnableButtons() {
      btnVoice.disabled = !micPermissionGranted;
      btnVideoStart.disabled = !(micPermissionGranted && camPermissionGranted);
    }

    // Mikrofon izni isteme
    btnMicPermission.onclick = () => {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          micPermissionGranted = true;
          audioStream = stream;
          status.textContent = '✅ Mikrofon izni verildi.';
          btnMicPermission.disabled = true;
          btnMicPermission.textContent = '🎤 Mikrofon İzni Verildi';
          checkEnableButtons();
          // Mikrofon akışını kapatıyoruz, konuşma başlatınca açarız
          stream.getTracks().forEach(track => track.stop());
        })
        .catch(err => {
          status.textContent = '❌ Mikrofon izni reddedildi veya hata: ' + err.message;
        });
    };

    // Kamera izni isteme
    btnCamPermission.onclick = () => {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          camPermissionGranted = true;
          status.textContent = '✅ Kamera izni verildi.';
          btnCamPermission.disabled = true;
          btnCamPermission.textContent = '📷 Kamera İzni Verildi';
          checkEnableButtons();
          // Kamerayı kapatıyoruz, görüntülü konuşma başlatınca açarız
          stream.getTracks().forEach(track => track.stop());
        })
        .catch(err => {
          status.textContent = '❌ Kamera izni reddedildi veya hata: ' + err.message;
        });
    };

    // Sesli konuşmayı başlat / durdur
    btnVoice.onclick = () => {
      if (listening) {
        stopRecognition();
        btnVoice.textContent = '🎤 Sesli Konuşmayı Başlat';
        status.textContent = 'Durum: Sesli konuşma durduruldu.';
        if (idleTimer) clearTimeout(idleTimer);
        return;
      }

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          audioStream = stream;
          recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
          recognition.lang = 'tr-TR';
          recognition.interimResults = false;
          recognition.continuous = true;

          recognition.onresult = (event) => {
            resetIdleTimer();
            const speech = event.results[event.results.length -1][0].transcript.toLowerCase();
            log.textContent += `\n👤 Sen: ${speech}`;
            log.scrollTop = log.scrollHeight;
            botCevapVer(speech);
          };

          recognition.onerror = (event) => {
            status.textContent = `⚠️ Ses tanıma hatası: ${event.error}`;
          };

          recognition.onend = () => {
            if(listening) recognition.start();
            else status.textContent = 'Durum: Sesli konuşma kapandı.';
          };

          recognition.start();
          resetIdleTimer();
          listening = true;
          btnVoice.textContent = '🛑 Sesli Konuşmayı Durdur';
          status.textContent = 'Durum: Mikrofon aktif, seni dinliyorum...';
          log.textContent = '📝 Konuşma logu başlatıldı.';
        })
        .catch(err => {
          status.textContent = '❌ Mikrofon izni reddedildi veya hata: ' + err.message;
        });
    };

    // Görüntülü konuşmayı başlat
    btnVideoStart.onclick = () => {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.style.display = 'block';

          btnVideoStart.disabled = true;
          btnVideoStop.disabled = false;

          status.textContent = 'Durum: Kamera ve mikrofon açık, görüntülü konuşma başladı.';
          log.textContent += '\n📹 Görüntülü konuşma başladı.';
        })
        .catch(err => {
          status.textContent = '❌ Kamera veya mikrofon izni reddedildi: ' + err.message;
        });
    };

    // Görüntülü konuşmayı durdur
    btnVideoStop.onclick = () => {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        video.style.display = 'none';
        btnVideoStart.disabled = false;
        btnVideoStop.disabled = true;

        status.textContent = 'Durum: Görüntülü konuşma durduruldu.';
        log.textContent += '\n⏹️ Görüntülü konuşma durduruldu.';
      }
    };

    // Botun basit cevap fonksiyonu
    function botCevapVer(sozcuk) {
      let cevap = '';
      if (sozcuk.includes('nasılsın')) cevap = 'İyiyim, teşekkür ederim! Sen nasılsın? 😊';
      else if (sozcuk.includes('merhaba')) cevap = 'Merhaba! Sana nasıl yardımcı olabilirim? 🤖';
      else if (sozcuk.includes('görüşürüz')) {
        cevap = 'Görüşmek üzere! İyi günler! 👋';
        stopRecognition();
      }
      else cevap = 'Üzgünüm, bunu anlayamadım. Lütfen tekrar eder misin? 🤔';

      log.textContent += `\n🤖 Bot: ${cevap}`;
      log.scrollTop = log.scrollHeight;
      botKonus(cevap);
    }

    // Ses tanımayı durdur
    function stopRecognition() {
      listening = false;
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
      status.textContent = 'Durum: Sesli konuşma kapandı.';
      if (idleTimer) clearTimeout(idleTimer);
    }
  </script>

</body>
</html>
