<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>NovaTalk - AkÄ±llÄ± Sesli & GÃ¶rÃ¼ntÃ¼lÃ¼ Asistan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 30px;
      /* Daha dinamik ve canlÄ± bir arka plan gradienti */
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); 
      color: #2c3e50; /* Koyu gri tonu */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0;
      overflow-x: hidden; /* Yatay kaydÄ±rmayÄ± engelle */
    }
    h1 {
      color: #2980b9; /* CanlÄ± mavi baÅŸlÄ±k rengi */
      margin-bottom: 25px;
      font-size: 2.8em; /* Daha bÃ¼yÃ¼k baÅŸlÄ±k */
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2); /* Daha belirgin gÃ¶lge */
      letter-spacing: 1px;
    }
    div {
      margin-bottom: 15px;
    }
    button {
      font-size: 1.15em; /* Daha bÃ¼yÃ¼k font */
      padding: 15px 35px; /* Daha geniÅŸ padding */
      margin: 12px;
      border-radius: 30px; /* Daha da yuvarlak butonlar */
      border: none;
      background-color: #27ae60; /* YeÅŸil tonu */
      color: white;
      cursor: pointer;
      min-width: 200px; /* Daha geniÅŸ butonlar */
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      user-select: none;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3); /* Daha belirgin gÃ¶lge */
      letter-spacing: 0.8px;
      font-weight: 600; /* KalÄ±n font */
    }
    button:hover {
      background-color: #2ecc71; /* Hover'da hafif aÃ§Ä±lan yeÅŸil */
      transform: translateY(-3px); /* Daha belirgin yukarÄ± kalkma efekti */
      box-shadow: 0 8px 16px rgba(0,0,0,0.4); /* Hover'da daha koyu gÃ¶lge */
    }
    button:active {
      transform: translateY(0); /* BasÄ±ldÄ±ÄŸÄ±nda eski yerine dÃ¶nme */
      box-shadow: 0 3px 6px rgba(0,0,0,0.2); /* BasÄ±ldÄ±ÄŸÄ±nda gÃ¶lgenin kÃ¼Ã§Ã¼lmesi */
    }
    button.stop {
      background-color: #e74c3c; /* KÄ±rmÄ±zÄ± tonu */
    }
    button.stop:hover {
      background-color: #c0392b; /* Daha koyu kÄ±rmÄ±zÄ± */
    }
    button:disabled {
      background-color: #bdc3c7; /* AÃ§Ä±k gri ve pasif gÃ¶rÃ¼nÃ¼m */
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
      opacity: 0.7; /* Hafif ÅŸeffaflÄ±k */
    }
    video {
      margin-top: 30px;
      max-width: 450px; /* Daha geniÅŸ video alanÄ± */
      width: 90%;
      border-radius: 20px; /* Daha yuvarlak kÃ¶ÅŸeler */
      box-shadow: 0 10px 20px rgba(0,0,0,0.4); /* Daha belirgin gÃ¶lge */
      display: none;
      background-color: #000;
      border: 5px solid #3498db; /* CanlÄ± mavi Ã§erÃ§eve */
    }
    #status {
      margin-top: 30px;
      font-size: 1.2em; /* Daha bÃ¼yÃ¼k font */
      color: #2c3e50; /* Koyu metin rengi */
      font-weight: bold;
      min-height: 30px;
      text-shadow: 0 1px 1px rgba(255,255,255,0.5); /* Hafif metin gÃ¶lgesi */
    }
    #log {
      margin-top: 25px;
      max-width: 450px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      background: #ecf0f1; /* AÃ§Ä±k gri log kutusu */
      padding: 20px;
      border-radius: 15px; /* Daha yuvarlak kÃ¶ÅŸeler */
      font-size: 1em; /* Daha standart font boyutu */
      white-space: pre-wrap;
      min-height: 120px; /* Daha yÃ¼ksek log alanÄ± */
      color: #34495e; /* Koyu metin rengi */
      border: 1px solid #bdc3c7; /* Gri kenarlÄ±k */
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Belirgin gÃ¶lge */
      overflow-y: auto;
      max-height: 250px; /* Daha yÃ¼ksek log alanÄ± */
      text-align: left;
      line-height: 1.5;
    }
  </style>
</head>
<body>

  <h1>NovaTalk ğŸš€</h1>

  <div>
    <button id="btnAudioStart">ğŸ¤ Sesli AsistanÄ± BaÅŸlat</button>
    <button id="btnAudioStop" class="stop" disabled>â¹ï¸ Sesli AsistanÄ± Durdur</button>
  </div>
  <div>
    <button id="btnVideoStart">ğŸ“¹ GÃ¶rÃ¼ntÃ¼lÃ¼ KonuÅŸma BaÅŸlat</button>
    <button id="btnVideoStop" class="stop" disabled>â¹ï¸ GÃ¶rÃ¼ntÃ¼lÃ¼ KonuÅŸmayÄ± Durdur</button>
  </div>

  <video id="video" autoplay playsinline></video>

  <div id="status"></div>
  <div id="log">KonuÅŸma logu buraya gelecek...</div>

  <script>
    const btnAudioStart = document.getElementById('btnAudioStart');
    const btnAudioStop = document.getElementById('btnAudioStop');
    const btnVideoStart = document.getElementById('btnVideoStart');
    const btnVideoStop = document.getElementById('btnVideoStop');
    const video = document.getElementById('video');
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');

    let recognition = null;
    let audioStream = null;
    let videoStream = null;
    let isListening = false;

    // Loglama fonksiyonu: MesajlarÄ± hem HTML'e hem de konsola yazdÄ±rÄ±r
    function appendToLog(message) {
      if (logDiv) {
        const now = new Date();
        const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        logDiv.textContent += `\n[${time}] ${message}`;
        logDiv.scrollTop = logDiv.scrollHeight; // KaydÄ±rma Ã§ubuÄŸunu aÅŸaÄŸÄ± indir
      }
      console.log(`[LOG]: ${message}`); // Her zaman konsola da yaz
    }

    // Durum mesajlarÄ±nÄ± gÃ¼ncelleyen fonksiyon
    function updateStatus(message) {
        if (statusDiv) {
            statusDiv.textContent = message;
        }
        appendToLog(`DURUM: ${message}`);
    }

    // Botun sesli yanÄ±t vermesini saÄŸlayan fonksiyon
    function botSpeak(text) {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'tr-TR';
      utterance.pitch = 1;
      utterance.rate = 1;
      utterance.volume = 1;
      utterance.onend = () => {
        appendToLog("Bot konuÅŸmasÄ± bitti.");
        // Bot konuÅŸmasÄ± bittikten sonra tekrar dinlemeyi baÅŸlat
        if (isListening && recognition && recognition.start) {
            try {
                recognition.start();
                updateStatus('Dinlemeye devam ediyorum...');
            } catch (e) {
                appendToLog(`Bot konuÅŸmasÄ± sonrasÄ± dinleme baÅŸlatÄ±lÄ±rken hata: ${e.message}`);
                console.error("Recognition re-start after botSpeak error:", e);
                updateStatus('Dinleme hatasÄ± oluÅŸtu.');
                isListening = false;
                stopRecognition();
            }
        }
      };
      utterance.onerror = (event) => {
        appendToLog(`Bot konuÅŸma hatasÄ±: ${event.error}`);
        console.error("SpeechSynthesis error:", event.error);
        updateStatus('Bot konuÅŸurken hata oluÅŸtu.');
      };
      speechSynthesis.speak(utterance);
      appendToLog(`NovaTalk sÃ¶yledi: ${text}`);
    }

    // Ses tanÄ±mayÄ± baÅŸlatan fonksiyon
    function startRecognition() {
      // TarayÄ±cÄ± uyumluluk kontrolÃ¼
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        updateStatus('TarayÄ±cÄ±nÄ±z ses tanÄ±mayÄ± desteklemiyor! LÃ¼tfen Chrome gibi destekleyen bir tarayÄ±cÄ± kullanÄ±n.');
        appendToLog('Hata: TarayÄ±cÄ± ses tanÄ±mayÄ± desteklemiyor.');
        alert('TarayÄ±cÄ±nÄ±z ses tanÄ±mayÄ± desteklemiyor! LÃ¼tfen Chrome gibi destekleyen bir tarayÄ±cÄ± kullanÄ±n.');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'tr-TR';
      recognition.interimResults = false; // Ara sonuÃ§larÄ± deÄŸil, sadece kesin sonuÃ§larÄ± dÃ¶ndÃ¼r
      recognition.maxAlternatives = 1; // En iyi tahmini dÃ¶ndÃ¼r
      recognition.continuous = false; // KonuÅŸma durduktan sonra otomatik olarak durdur

      recognition.onstart = () => {
        updateStatus('KonuÅŸmanÄ± dinliyorum... Mikrofonun aÃ§Ä±k.');
        appendToLog('Ses tanÄ±ma baÅŸlatÄ±ldÄ±. Dinleniyor...');
        isListening = true; // Dinleme durumunu aktif et
      };

      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript.toLowerCase();
        appendToLog('Sen sÃ¶yledin: "' + text + '"');
        updateStatus('AnladÄ±m: ' + text);
        botReply(text); // Botun yanÄ±t vermesi
      };

      recognition.onerror = (event) => {
        updateStatus('Hata: ' + event.error);
        appendToLog(`Ses tanÄ±ma hatasÄ±: ${event.error}. Detay: ${event.message || 'Bilinmiyor.'}`);
        console.error("SpeechRecognition error:", event.error);

        if (event.error === 'not-allowed') {
          appendToLog('Mikrofon eriÅŸimi reddedildi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±nÄ±zdan izin verin.');
          updateStatus('Mikrofon izni reddedildi. SayfayÄ± yenileyip tekrar deneyin.');
        } else if (event.error === 'no-speech') {
          appendToLog('KonuÅŸma algÄ±lanmadÄ±. LÃ¼tfen daha net ve yakÄ±n konuÅŸun.');
          updateStatus('KonuÅŸma algÄ±lanmadÄ±. Tekrar deniyorum...');
          // KÃ¼Ã§Ã¼k bir gecikmeyle yeniden baÅŸlatmayÄ± dene
          if(isListening) {
              setTimeout(() => {
                  try {
                      recognition.start();
                  } catch (e) {
                      appendToLog(`'no-speech' sonrasÄ± tekrar baÅŸlatÄ±lÄ±rken hata: ${e.message}`);
                      console.error("Recognition restart after no-speech error:", e);
                  }
              }, 500); // 0.5 saniye sonra tekrar dene
          }
        } else if (event.error === 'audio-capture') {
          appendToLog('Mikrofon ÅŸu anda kullanÄ±lamÄ±yor veya baÅŸka bir uygulama tarafÄ±ndan kullanÄ±lÄ±yor.');
          updateStatus('Mikrofon hatasÄ±. BaÅŸka bir uygulama kullanÄ±yor olabilir.');
        } else if (event.error === 'network') {
          appendToLog('AÄŸ baÄŸlantÄ± hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
          updateStatus('AÄŸ hatasÄ±. BaÄŸlantÄ±nÄ±zÄ± kontrol edin.');
        } else if (event.error === 'aborted') {
            appendToLog('Ses tanÄ±ma iÅŸlemi iptal edildi.');
            // Bu hata stopAll() Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda doÄŸal olarak oluÅŸabilir.
            // Bu yÃ¼zden isListening false ise tekrar baÅŸlatmaya Ã§alÄ±ÅŸma.
        }
        
        if (isListening && !['no-speech', 'aborted'].includes(event.error)) { // no-speech dÄ±ÅŸÄ±ndaki hatalarda durdur
             isListening = false;
             stopRecognition(); // KalÄ±cÄ± olarak durdur
        }
      };

      recognition.onend = () => {
        appendToLog('Ses tanÄ±ma sona erdi.');
        if(isListening) { // EÄŸer isListening hala true ise, bot konuÅŸmasÄ± bittikten sonra tekrar baÅŸlayacak.
          // Bu kÄ±sÄ±m botSpeak iÃ§indeki onend callback'ine taÅŸÄ±ndÄ±.
          // Burada sadece durum gÃ¼ncellenebilir eÄŸer bot konuÅŸmasÄ± beklenmiyorsa.
          updateStatus('Dinlemeye devam ediliyor (konuÅŸma bekleniyor)...');
        } else {
          updateStatus('Ses tanÄ±ma durdu.');
          appendToLog('Ses tanÄ±ma kalÄ±cÄ± olarak durduruldu.');
        }
      };

      try {
        recognition.start();
      } catch (e) {
        appendToLog(`Ses tanÄ±ma baÅŸlatÄ±lÄ±rken genel hata oluÅŸtu: ${e.message}`);
        console.error("Recognition start initial error:", e);
        updateStatus('Ses tanÄ±ma baÅŸlatÄ±lamadÄ±. LÃ¼tfen tekrar deneyin.');
        isListening = false;
      }
    }

    // Botun kullanÄ±cÄ±nÄ±n sÃ¶ylediklerine verdiÄŸi yanÄ±tlar (KonuÅŸma MantÄ±ÄŸÄ±)
    function botReply(text) {
      let replyText = '';
      const now = new Date();

      if (text.includes('merhaba') || text.includes('selam')) {
        replyText = 'Merhaba! NovaTalk hizmetinizdeyim. Size nasÄ±l yardÄ±mcÄ± olabilirim?';
      } else if (text.includes('nasÄ±lsÄ±n')) {
        replyText = 'Ben bir yapay zekayÄ±m, iyiyim teÅŸekkÃ¼r ederim. Siz nasÄ±lsÄ±nÄ±z?';
      } else if (text.includes('adÄ±n ne') || text.includes('kimsin')) {
        replyText = 'Ben NovaTalk, dijital asistanÄ±nÄ±zÄ±m.';
      } else if (text.includes('saat kaÃ§') || text.includes('saati sÃ¶yle')) {
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        replyText = `Åu an saat ${hours}:${minutes}.`;
      } else if (text.includes('bugÃ¼n gÃ¼nlerden ne') || text.includes('tarih ne')) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        replyText = `BugÃ¼n ${now.toLocaleDateString('tr-TR', options)}.`;
      } else if (text.includes('yardÄ±m et') || text.includes('ne yapabilirsin')) {
        replyText = 'Size saati sÃ¶yleyebilir, gÃ¼nÃ¼n tarihini belirtebilir veya sadece sohbet edebilirim. Ne sormak istersiniz?';
      } else if (text.includes('gÃ¼le gÃ¼le') || text.includes('gÃ¶rÃ¼ÅŸÃ¼rÃ¼z') || text.includes('kapat') || text.includes('bitir')) {
        replyText = 'GÃ¶rÃ¼ÅŸmek Ã¼zere! Kendinize iyi bakÄ±n.';
        setTimeout(() => stopAll(), 1500); // Bot konuÅŸmayÄ± bitirdikten sonra kapat
      } else {
        const randomReplies = [
          'ÃœzgÃ¼nÃ¼m, dediÄŸinizi tam anlayamadÄ±m. Tekrar sÃ¶yler misiniz?',
          'LÃ¼tfen daha net konuÅŸur musunuz?',
          'Kusura bakmayÄ±n, anlayamadÄ±m. Ne demek istediniz?',
          'Tekrar edebilir misiniz?'
        ];
        replyText = randomReplies[Math.floor(Math.random() * randomReplies.length)];
      }
      botSpeak(replyText);
    }

    // Ses tanÄ±mayÄ± durduran fonksiyon
    function stopRecognition() {
      if(recognition) {
        isListening = false; // Dinlemeyi tamamen kapat
        recognition.stop();
        appendToLog('Ses tanÄ±ma durdurma komutu gÃ¶nderildi.');
      }
      recognition = null; // Recognition objesini sÄ±fÄ±rla
    }

    // Kamera ve mikrofon akÄ±ÅŸlarÄ±nÄ± durduran fonksiyon
    function stopStreams() {
      if(audioStream) {
        audioStream.getTracks().forEach(t => t.stop());
        audioStream = null;
        appendToLog('Ses akÄ±ÅŸÄ± durduruldu.');
      }
      if(videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
        video.srcObject = null;
        appendToLog('Video akÄ±ÅŸÄ± durduruldu.');
      }
      video.style.display = 'none';
    }

    // TÃ¼m aktif iÅŸlemleri durduran ana fonksiyon
    function stopAll() {
      appendToLog('TÃ¼m konuÅŸma ve akÄ±ÅŸlar sonlandÄ±rÄ±lÄ±yor...');
      stopRecognition();
      stopStreams();
      updateStatus('KonuÅŸma sonlandÄ±rÄ±ldÄ±. Tekrar baÅŸlatmak iÃ§in dÃ¼ÄŸmelere tÄ±klayÄ±n.');
      appendToLog('NovaTalk tamamen sonlandÄ±rÄ±ldÄ±.');

      // Buton durumlarÄ±nÄ± baÅŸlangÄ±Ã§ haline getir
      btnAudioStart.disabled = false;
      btnAudioStop.disabled = true;
      btnVideoStart.disabled = false;
      btnVideoStop.disabled = true;
    }

    // Sayfa yÃ¼klendiÄŸinde baÅŸlangÄ±Ã§ log mesajÄ±nÄ± ve durumu gÃ¶ster
    appendToLog("NovaTalk hazÄ±r. LÃ¼tfen 'Sesli AsistanÄ± BaÅŸlat' veya 'GÃ¶rÃ¼ntÃ¼lÃ¼ KonuÅŸma BaÅŸlat' dÃ¼ÄŸmelerinden birine tÄ±klayÄ±n.");
    updateStatus("HoÅŸ geldiniz! BaÅŸlamak iÃ§in bir seÃ§enek seÃ§in.");


    // Sesli KonuÅŸma BaÅŸlat dÃ¼ÄŸmesine tÄ±klama olayÄ±
    btnAudioStart.onclick = () => {
      stopAll(); // Ã–nceki tÃ¼m iÅŸlemleri durdur
      appendToLog('Sesli asistan baÅŸlatma isteÄŸi.');
      updateStatus('Mikrofon izni bekleniyor...');

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          audioStream = stream;
          video.style.display = 'none';
          updateStatus('Mikrofon izni verildi. Dinliyorum...');
          appendToLog('Mikrofon izni baÅŸarÄ±yla alÄ±ndÄ±. Ses tanÄ±ma baÅŸlatÄ±lÄ±yor.');

          btnAudioStart.disabled = true;
          btnAudioStop.disabled = false;
          btnVideoStart.disabled = true;
          btnVideoStop.disabled = true;

          startRecognition(); // Ses tanÄ±mayÄ± baÅŸlat
        })
        .catch(err => {
          updateStatus('Mikrofon izni reddedildi: ' + err.message);
          appendToLog('Hata: Mikrofon izni reddedildi veya eriÅŸilemiyor. Detay: ' + err.name + " - " + err.message);
          console.error("getUserMedia (audio) error:", err);
          stopAll(); // Hata durumunda her ÅŸeyi sÄ±fÄ±rla
          alert('Mikrofon izni reddedildi veya mikrofon kullanÄ±lamÄ±yor. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±nÄ±zÄ± kontrol edin ve tekrar deneyin.');
        });
    };

    // Sesli KonuÅŸmayÄ± Durdur dÃ¼ÄŸmesine tÄ±klama olayÄ±
    btnAudioStop.onclick = () => {
      stopAll();
      appendToLog('Sesli asistan durduruldu.');
    };

    // GÃ¶rÃ¼ntÃ¼lÃ¼ KonuÅŸma BaÅŸlat dÃ¼ÄŸmesine tÄ±klama olayÄ±
    btnVideoStart.onclick = () => {
      stopAll();
      appendToLog('GÃ¶rÃ¼ntÃ¼lÃ¼ konuÅŸma baÅŸlatma isteÄŸi.');
      updateStatus('Kamera ve mikrofon izni bekleniyor...');

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.style.display = 'block';
          updateStatus('Kamera ve mikrofon izni verildi. Dinliyorum...');
          appendToLog('Kamera ve mikrofon izni baÅŸarÄ±yla alÄ±ndÄ±. Ses tanÄ±ma baÅŸlatÄ±lÄ±yor.');

          btnVideoStart.disabled = true;
          btnVideoStop.disabled = false;
          btnAudioStart.disabled = true;
          btnAudioStop.disabled = true;

          startRecognition();
        })
        .catch(err => {
          updateStatus('Kamera veya mikrofon izni reddedildi: ' + err.message);
          appendToLog('Hata: Kamera veya mikrofon izni reddedildi veya eriÅŸilemiyor. Detay: ' + err.name + " - " + err.message);
          console.error("getUserMedia (video+audio) error:", err);
          stopAll();
          alert('Kamera veya mikrofon izni reddedildi veya kullanÄ±lamÄ±yor. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±nÄ±zÄ± kontrol edin ve tekrar deneyin.');
        });
    };

    // GÃ¶rÃ¼ntÃ¼lÃ¼ KonuÅŸmayÄ± Durdur dÃ¼ÄŸmesine tÄ±klama olayÄ±
    btnVideoStop.onclick = () => {
      stopAll();
      appendToLog('GÃ¶rÃ¼ntÃ¼lÃ¼ konuÅŸma durduruldu.');
    };
  </script>

</body>
</html>
