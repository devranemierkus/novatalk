<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NovaTalk - Sesli & GÃ¶rÃ¼ntÃ¼lÃ¼ Arama</title>
<style>
  /* --- GENEL STÄ°L --- */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0;
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f3f5;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    user-select: none;
  }
  button {
    cursor: pointer;
    outline: none;
  }
  /* --- MENÃœ --- */
  #menu {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #ffffff;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
  }
  #menu button {
    border-radius: 30px;
    background: #26a69a;
    border: none;
    color: white;
    font-weight: 600;
    font-size: 18px;
    padding: 10px 24px;
    transition: background-color 0.3s ease;
  }
  #menu button:hover:not(:disabled) {
    background-color: #1b7d74;
  }
  #menu button:disabled {
    background-color: #999999;
    cursor: not-allowed;
  }

  /* --- Ä°ZÄ°N EKRANI --- */
  #permissionScreen {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.6);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    color: white;
    font-size: 20px;
    text-align: center;
    padding: 20px;
  }
  #permissionScreen button {
    margin-top: 20px;
    background: #00bfa5;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-size: 18px;
    font-weight: bold;
  }
  #permissionScreen button:hover {
    background: #008e79;
  }

  /* --- ARAMA EKRANI --- */
  #callScreen {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100vw;
    height: 100vh;
    background: #0a4840;
    color: white;
    position: relative;
  }
  #localVideo {
    width: 320px;
    height: 240px;
    border-radius: 12px;
    background: black;
    object-fit: cover;
  }
  #avatar {
    margin-top: 20px;
    width: 150px;
    height: 150px;
    background: #26a69a;
    border-radius: 50%;
    position: relative;
  }
  .eye {
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 45px;
    box-shadow: inset 0 0 3px #444;
  }
  .eye.left { left: 30px; }
  .eye.right { right: 30px; }
  .pupil {
    width: 8px;
    height: 8px;
    background: #004d40;
    border-radius: 50%;
    position: absolute;
    top: 6px;
    left: 6px;
    transition: transform 0.3s ease;
  }
  #mouth {
    width: 60px;
    height: 25px;
    background: #004d40;
    border-radius: 0 0 30px 30px;
    position: absolute;
    bottom: 35px;
    left: 50%;
    transform: translateX(-50%);
    transition: height 0.15s ease;
  }

  /* --- SESLÄ° KONUÅžMA TUÅžU --- */
  #talkBtn {
    margin-top: 25px;
    background: #00bfa5;
    color: white;
    border: none;
    border-radius: 40px;
    padding: 16px 40px;
    font-size: 20px;
    font-weight: bold;
    user-select: none;
  }
  #talkBtn:active {
    background: #008e79;
  }

  /* --- KAPAT TUÅžU --- */
  #hangupBtn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #e53935;
    border: none;
    color: white;
    font-weight: bold;
    font-size: 18px;
    padding: 10px 20px;
    border-radius: 30px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #hangupBtn:hover {
    background: #b52b27;
  }

  /* --- MESAJ KUTUSU --- */
  #logBox {
    margin-top: 20px;
    width: 90vw;
    max-width: 480px;
    max-height: 150px;
    overflow-y: auto;
    background: #00382b;
    border-radius: 10px;
    padding: 10px;
    font-size: 16px;
    line-height: 1.4;
    color: #a5d6a7;
    user-select: text;
    box-shadow: 0 0 10px #00bfa5;
  }

</style>
</head>
<body>

  <!-- Ä°ZÄ°N EKRANI -->
  <div id="permissionScreen" style="display:none;">
    <div><strong>NovaTalk</strong> mikrofon ve kamera izinlerine ihtiyaÃ§ duyuyor.</div>
    <button id="allowPermissionsBtn">Ä°zin Ver</button>
  </div>

  <!-- ANA MENÃœ -->
  <div id="menu">
    <button id="startAudioCallBtn">Sesli Arama BaÅŸlat</button>
    <button id="startVideoCallBtn">GÃ¶rÃ¼ntÃ¼lÃ¼ Arama BaÅŸlat</button>
  </div>

  <!-- ARAMA EKRANI -->
  <div id="callScreen">
    <video id="localVideo" autoplay muted playsinline></video>

    <div id="avatar" aria-label="Avatar animasyonu" role="img">
      <div class="eye left"><div class="pupil"></div></div>
      <div class="eye right"><div class="pupil"></div></div>
      <div id="mouth"></div>
    </div>

    <button id="talkBtn" title="BasÄ±lÄ± tut & konuÅŸ" aria-pressed="false">ðŸŽ¤ BasÄ±lÄ± Tut & KonuÅŸ</button>
    <button id="hangupBtn" aria-label="AramayÄ± kapat">Kapat</button>

    <div id="logBox" aria-live="polite" aria-atomic="false"></div>
  </div>

<script>
(async () => {
  // ELEMENTLER
  const permissionScreen = document.getElementById('permissionScreen');
  const allowPermissionsBtn = document.getElementById('allowPermissionsBtn');
  const menu = document.getElementById('menu');
  const callScreen = document.getElementById('callScreen');
  const startAudioCallBtn = document.getElementById('startAudioCallBtn');
  const startVideoCallBtn = document.getElementById('startVideoCallBtn');
  const localVideo = document.getElementById('localVideo');
  const talkBtn = document.getElementById('talkBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const avatarMouth = document.getElementById('mouth');
  const pupils = document.querySelectorAll('.pupil');
  const logBox = document.getElementById('logBox');

  // DURUMLAR
  let isCalling = false;
  let isVideoCall = false;
  let mediaStream = null;
  let recognition = null;
  let isTalking = false;
  let speechSynthesisUtterance = null;

  // Ä°ZÄ°N KONTROLÃœ
  function hasPermissions() {
    return localStorage.getItem('permissionsGranted') === 'true';
  }

  // Ä°ZÄ°N Ä°STEME
  async function requestPermissions() {
    try {
      await navigator.mediaDevices.getUserMedia({audio:true, video:true});
      localStorage.setItem('permissionsGranted', 'true');
      return true;
    } catch(e) {
      return false;
    }
  }

  // LOG EKLEME
  function log(message, isUser = false) {
    const p = document.createElement('p');
    p.textContent = (isUser ? "Sen: " : "Bot: ") + message;
    if(isUser) p.style.color = '#81c784';
    logBox.appendChild(p);
    logBox.scrollTop = logBox.scrollHeight;
  }

  // AVATAR ANÄ°MASYONU - GÃ¶z rastgele hareketi
  setInterval(() => {
    pupils.forEach(pupil => {
      const x = Math.random()*6 - 3;
      const y = Math.random()*6 - 3;
      pupil.style.transform = `translate(${x}px, ${y}px)`;
    });
  }, 2500);

  // AVATAR ANÄ°MASYONU - GÃ¶z KÄ±rpma
  let eyeOpen = true;
  setInterval(() => {
    if(!eyeOpen) {
      document.querySelectorAll('.eye').forEach(e => e.style.opacity = '1');
      eyeOpen = true;
    } else {
      document.querySelectorAll('.eye').forEach(e => e.style.opacity = '0.2');
      eyeOpen = false;
    }
  }, 6000);

  // AVATAR AÄžIZ HAREKETÄ°
  function openMouth() {
    avatarMouth.style.height = '45px';
  }
  function closeMouth() {
    avatarMouth.style.height = '25px';
  }

  // BOT CEVABI (Ã–RNEK - GEMINI veya baÅŸka API EKLENEBÄ°LÄ°R)
  async function botResponse(text) {
    // Ã–rnek basit cevaplar:
    const txt = text.toLowerCase();
    let reply = "ÃœzgÃ¼nÃ¼m, anlayamadÄ±m.";
    if(txt.includes('merhaba')) reply = "Merhaba! Sana nasÄ±l yardÄ±mcÄ± olabilirim?";
    else if(txt.includes('nasÄ±lsÄ±n')) reply = "Ä°yiyim, teÅŸekkÃ¼r ederim! Sen nasÄ±lsÄ±n?";
    else if(txt.includes('gÃ¶rÃ¼ÅŸÃ¼rÃ¼z') || txt.includes('hoÅŸÃ§a kal')) reply = "HoÅŸÃ§a kal! Ä°yi gÃ¼nler!";
    else if(txt.includes('nasÄ±l Ã§alÄ±ÅŸÄ±yorsun')) reply = "Ben NovaTalk botuyum, sesli ve gÃ¶rÃ¼ntÃ¼lÃ¼ aramalar iÃ§in buradayÄ±m.";
    // Buraya gerÃ§ek API Ã§aÄŸrÄ±sÄ± entegre edilebilir

    log(reply, false);
    return reply;
  }

  // TEXT-TO-SPEECH OKUMA
  function speakText(text) {
    if(window.speechSynthesis.speaking) {
      window.speechSynthesis.cancel();
    }
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'tr-TR';
    utterance.onstart = () => openMouth();
    utterance.onend = () => closeMouth();
    window.speechSynthesis.speak(utterance);
  }

  // SESLÄ° TANIMA AYARLARI
  function setupSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition) {
      alert("TarayÄ±cÄ±nÄ±z sesli tanÄ±mayÄ± desteklemiyor.");
      return null;
    }
    const recog = new SpeechRecognition();
    recog.lang = 'tr-TR';
    recog.interimResults = false;
    recog.maxAlternatives = 1;

    recog.onstart = () => {
      isTalking = true;
      talkBtn.setAttribute('aria-pressed', 'true');
      openMouth();
      statusText("Dinleniyor...");
    };

    recog.onresult = async (event) => {
      const transcript = event.results[0][0].transcript;
      log(transcript, true);
      const reply = await botResponse(transcript);
      speakText(reply);
    };

    recog.onerror = (e) => {
      console.error("SpeechRecognition Hata:", e.error);
      statusText("Hata: " + e.error);
    };

    recog.onend = () => {
      isTalking = false;
      talkBtn.setAttribute('aria-pressed', 'false');
      closeMouth();
      statusText("KonuÅŸmak iÃ§in basÄ±lÄ± tutun.");
    };
    return recog;
  }

  // DURUM MESAJI GÃ–STER
  function statusText(text) {
    // LogBox iÃ§ine bir satÄ±r olarak koyabiliriz:
    // ya da Ã¶zel durum metni gÃ¶ster
    // Burada logBox'a deÄŸil Ã¼stte izin ekranÄ±na yazacaÄŸÄ±z:
    if(isCalling) {
      logBox.appendChild(Object.assign(document.createElement('p'), {textContent: text, style:"color:#90caf9;font-style:italic;"}));
      logBox.scrollTop = logBox.scrollHeight;
    }
  }

  // Ã‡AÄžRIYI BAÅžLAT
  async function startCall(video=false) {
    if(!hasPermissions()) {
      alert("LÃ¼tfen Ã¶nce izin verin.");
      showPermissionScreen();
      return;
    }
    isCalling = true;
    isVideoCall = video;
    menu.style.display = 'none';
    callScreen.style.display = 'flex';

    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({
        audio: true,
        video: video ? {width:320, height:240, facingMode: "user"} : false
      });
    } catch(err) {
      alert("Kamera veya mikrofon eriÅŸimi reddedildi.");
      endCall();
      return;
    }
    // Video elementi sadece video Ã§aÄŸrÄ±sÄ±nda gÃ¶sterilir:
    if(video) {
      localVideo.srcObject = mediaStream;
      localVideo.style.display = 'block';
    } else {
      localVideo.style.display = 'none';
    }

    recognition = setupSpeechRecognition();

    statusText("KonuÅŸmak iÃ§in basÄ±lÄ± tutun.");

  }

  // Ã‡AÄžRIYI SONLANDIR
  function endCall() {
    isCalling = false;
    isVideoCall = false;
    if(mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
    }
    if(recognition) {
      recognition.abort();
      recognition = null;
    }
    callScreen.style.display = 'none';
    menu.style.display = 'flex';
    logBox.innerHTML = '';
  }

  // Ä°ZÄ°N EKRANINI GÃ–STER
  function showPermissionScreen() {
    permissionScreen.style.display = 'flex';
    menu.style.display = 'none';
    callScreen.style.display = 'none';
  }

  // Ä°ZÄ°N EKRANINI KAPAT
  function hidePermissionScreen() {
    permissionScreen.style.display = 'none';
    menu.style.display = 'flex';
  }

  // Ä°ZÄ°N BUTONU
  allowPermissionsBtn.onclick = async () => {
    const allowed = await requestPermissions();
    if(allowed) {
      localStorage.setItem('permissionsGranted', 'true');
      hidePermissionScreen();
      alert("Ä°zinler baÅŸarÄ±yla verildi! Sesli ve gÃ¶rÃ¼ntÃ¼lÃ¼ arama yapabilirsiniz.");
    } else {
      alert("Ä°zin vermediÄŸiniz iÃ§in uygulama Ã§alÄ±ÅŸmaz.");
    }
  };

  // SESLÄ° KONUÅžMA BUTONU BASILI TUTMA Ä°ÅžLEMÄ°
  talkBtn.addEventListener('touchstart', e => {
    e.preventDefault();
    if(recognition && !isTalking) {
      recognition.start();
    }
  });
  talkBtn.addEventListener('touchend', e => {
    e.preventDefault();
    if(recognition && isTalking) {
      recognition.stop();
    }
  });
  talkBtn.addEventListener('mousedown', e => {
    e.preventDefault();
    if(recognition && !isTalking) {
      recognition.start();
    }
  });
  talkBtn.addEventListener('mouseup', e => {
    e.preventDefault();
    if(recognition && isTalking) {
      recognition.stop();
    }
  });

  // MENÃœ BUTONLARI
  startAudioCallBtn.onclick = () => {
    if(!hasPermissions()) {
      showPermissionScreen();
      return;
    }
    startCall(false);
  };
  startVideoCallBtn.onclick = () => {
    if(!hasPermissions()) {
      showPermissionScreen();
      return;
    }
    startCall(true);
  };

  // KAPAT BUTONU
  hangupBtn.onclick = () => {
    if(window.speechSynthesis.speaking) {
      window.speechSynthesis.cancel();
    }
    endCall();
  };

  // SAYFA YÃœKLENDÄ°ÄžÄ°NDE Ä°ZÄ°N VARSA GÃ–STER
  if(!hasPermissions()) {
    showPermissionScreen();
  } else {
    hidePermissionScreen();
  }

})();
</script>

</body>
</html>
